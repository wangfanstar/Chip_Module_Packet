<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>MAC Client â†’ PMD æŠ¥æ–‡å‘é€å…¨è·¯å¾„åŠ¨ç”»æ¼”ç¤º</title>  
    <link rel="stylesheet" href="common.css">  
    <style>  
        /* ========== Page-Specific Styles ========== */  

        /* --- Pipeline Container --- */  
        .pipeline {  
            position: relative;  
        }  

        .pipeline-module {  
            background: var(--bg-card);  
            border: 2px solid var(--border-color);  
            border-radius: var(--border-radius);  
            margin-bottom: 8px;  
            overflow: hidden;  
            transition: all 0.4s ease;  
            cursor: pointer;  
        }  

        .pipeline-module.active {  
            border-color: var(--accent-cyan);  
            box-shadow: var(--shadow-glow-cyan);  
        }  

        .pipeline-module.done {  
            border-color: rgba(105, 240, 174, 0.4);  
        }  

        .pipeline-module.uec {  
            border-left: 4px solid var(--accent-purple);  
        }  

        .pipeline-module .pm-header {  
            display: flex;  
            align-items: center;  
            justify-content: space-between;  
            padding: 12px 18px;  
            cursor: pointer;  
            user-select: none;  
        }  

        .pipeline-module .pm-header .pm-icon {  
            font-size: 1.2em;  
            margin-right: 10px;  
        }  

        .pipeline-module .pm-header .pm-title {  
            font-weight: 600;  
            font-size: 0.95em;  
            flex: 1;  
        }  

        .pipeline-module .pm-header .pm-layer {  
            font-size: 0.7em;  
            padding: 2px 8px;  
            border-radius: 10px;  
            background: rgba(100, 255, 218, 0.1);  
            color: var(--accent-cyan);  
            margin-left: 8px;  
            white-space: nowrap;  
        }  

        .pipeline-module .pm-header .pm-layer.uec-tag {  
            background: rgba(187, 134, 252, 0.15);  
            color: var(--accent-purple);  
        }  

        .pipeline-module .pm-header .pm-status {  
            font-size: 0.8em;  
            margin-left: 10px;  
            min-width: 20px;  
            text-align: center;  
        }  

        .pipeline-module .pm-body {  
            max-height: 0;  
            overflow: hidden;  
            transition: max-height 0.4s ease, padding 0.3s ease;  
            padding: 0 18px;  
        }  

        .pipeline-module .pm-body.open {  
            max-height: 2000px;  
            padding: 0 18px 16px;  
        }  

        .pipeline-module .pm-desc {  
            font-size: 0.85em;  
            color: var(--text-secondary);  
            line-height: 1.6;  
            margin-bottom: 10px;  
        }  

        .pipeline-module .pm-ref {  
            font-size: 0.75em;  
            color: var(--text-muted);  
            font-style: italic;  
        }  

        .pipeline-module .pm-data-view {  
            margin-top: 10px;  
        }  

        .pipeline-module .pm-data-label {  
            font-size: 0.75em;  
            color: var(--text-muted);  
            margin-bottom: 4px;  
        }  

        .pipeline-module .pm-data-box {  
            background: rgba(0, 0, 0, 0.3);  
            border: 1px solid var(--border-color);  
            border-radius: var(--border-radius-sm);  
            padding: 10px 12px;  
            font-family: var(--font-mono);  
            font-size: 0.78em;  
            min-height: 36px;  
            word-break: break-all;  
            overflow-x: auto;  
            transition: all 0.3s ease;  
        }  

        .pipeline-module.active .pm-data-box {  
            border-color: var(--accent-cyan);  
            box-shadow: inset 0 0 15px rgba(100, 255, 218, 0.05);  
        }  

        /* --- Packet Dot Animation --- */  
        .packet-dot {  
            position: absolute;  
            left: 50%;  
            width: 14px;  
            height: 14px;  
            border-radius: 50%;  
            background: var(--accent-cyan);  
            box-shadow: 0 0 12px rgba(100, 255, 218, 0.6);  
            transform: translateX(-50%);  
            z-index: 10;  
            transition: top 0.6s cubic-bezier(0.4, 0, 0.2, 1);  
            pointer-events: none;  
        }  

        .packet-dot.hidden {  
            opacity: 0;  
        }  

        /* --- Flow Arrow between modules --- */  
        .pipe-arrow {  
            text-align: center;  
            font-size: 1.1em;  
            color: var(--accent-cyan);  
            opacity: 0.35;  
            padding: 2px 0;  
            transition: opacity 0.3s ease;  
        }  
        .pipe-arrow.active {  
            opacity: 1;  
            animation: pulse-cyan 1.5s infinite;  
        }  

        /* --- Mini Architecture Diagram --- */  
        .arch-bar {  
            display: flex;  
            align-items: center;  
            gap: 4px;  
            padding: 12px 8px;  
            overflow-x: auto;  
            background: rgba(0, 0, 0, 0.2);  
            border-radius: var(--border-radius-sm);  
            margin-bottom: var(--spacing-lg);  
        }  

        .arch-bar .ab-block {  
            padding: 6px 10px;  
            border-radius: 6px;  
            font-size: 0.7em;  
            font-weight: 600;  
            white-space: nowrap;  
            border: 2px solid var(--border-color);  
            background: var(--bg-card);  
            transition: all 0.3s ease;  
            cursor: pointer;  
            text-align: center;  
            min-width: 65px;  
        }  

        .arch-bar .ab-block.active {  
            border-color: var(--accent-cyan);  
            background: rgba(100, 255, 218, 0.12);  
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.3);  
            color: var(--accent-cyan);  
        }  

        .arch-bar .ab-block.done {  
            border-color: rgba(105, 240, 174, 0.3);  
            color: var(--accent-green);  
        }  

        .arch-bar .ab-block.uec-bar {  
            border-color: rgba(187, 134, 252, 0.3);  
        }  

        .arch-bar .ab-arrow {  
            color: var(--text-muted);  
            font-size: 0.8em;  
            flex-shrink: 0;  
        }  

        /* --- Data Format Display --- */  
        .fmt-bytes {  
            display: inline-flex;  
            flex-wrap: wrap;  
            gap: 2px;  
        }  

        .fmt-bytes .fb {  
            display: inline-block;  
            padding: 2px 4px;  
            border-radius: 2px;  
            font-family: var(--font-mono);  
            font-size: 0.72em;  
            min-width: 22px;  
            text-align: center;  
        }  

        .fmt-label {  
            display: inline-block;  
            padding: 2px 6px;  
            border-radius: 3px;  
            font-size: 0.7em;  
            font-weight: 600;  
            margin-right: 4px;  
        }  

        /* Specific field colors */  
        .f-da     { background: #1565C0; color: #fff; }  
        .f-sa     { background: #0277BD; color: #fff; }  
        .f-type   { background: #00838F; color: #fff; }  
        .f-payload{ background: #2196f3; color: #fff; }  
        .f-fcs    { background: #f44336; color: #fff; }  
        .f-pre    { background: #9c27b0; color: #fff; }  
        .f-sfd    { background: #e91e63; color: #fff; }  
        .f-ipg    { background: #607d8b; color: #fff; }  
        .f-seq    { background: #4caf50; color: #fff; }  
        .f-sync   { background: #ff9800; color: #000; }  
        .f-bt     { background: #ff9800; color: #000; }  
        .f-scr    { background: #6A1B9A; color: #fff; }  
        .f-am     { background: #00BCD4; color: #000; }  
        .f-fec-d  { background: #3F51B5; color: #fff; }  
        .f-fec-p  { background: #E65100; color: #fff; }  
        .f-pam4   { background: #263238; color: #69f0ae; border: 1px solid #69f0ae; }  
        .f-light  { background: linear-gradient(135deg, #FFD54F, #FF7043); color: #000; }  

        /* --- Info Chips --- */  
        .info-chips {  
            display: flex;  
            flex-wrap: wrap;  
            gap: 6px;  
            margin-top: 8px;  
        }  

        .info-chip {  
            font-size: 0.7em;  
            padding: 3px 8px;  
            border-radius: 10px;  
            background: rgba(100, 255, 218, 0.08);  
            border: 1px solid rgba(100, 255, 218, 0.15);  
            color: var(--text-secondary);  
        }  

        .info-chip b {  
            color: var(--accent-cyan);  
        }  

        /* --- Speed control row --- */  
        .ctrl-row {  
            display: flex;  
            align-items: center;  
            gap: 12px;  
            flex-wrap: wrap;  
        }  

        /* --- Detail Table in module body --- */  
        .detail-grid {  
            display: grid;  
            grid-template-columns: auto 1fr;  
            gap: 4px 12px;  
            font-size: 0.82em;  
            margin: 8px 0;  
        }  

        .detail-grid .dg-key {  
            color: var(--text-muted);  
            white-space: nowrap;  
        }  

        .detail-grid .dg-val {  
            color: var(--text-primary);  
            font-family: var(--font-mono);  
            font-size: 0.92em;  
        }  

        /* --- Lane Distribution Visual --- */  
        .lane-vis {  
            display: grid;  
            grid-template-columns: repeat(8, 1fr);  
            gap: 4px;  
            margin: 8px 0;  
        }  

        .lane-vis .lane-box {  
            background: rgba(0, 0, 0, 0.3);  
            border: 1px solid var(--border-color);  
            border-radius: 4px;  
            padding: 4px;  
            text-align: center;  
            font-size: 0.65em;  
            font-family: var(--font-mono);  
            transition: all 0.3s ease;  
        }  

        .lane-vis .lane-box.active {  
            border-color: var(--accent-cyan);  
            background: rgba(100, 255, 218, 0.1);  
        }  

        .lane-vis .lane-box .lane-id {  
            font-weight: 700;  
            color: var(--accent-cyan);  
        }  

        /* --- PAM4 Eye Diagram (simple CSS) --- */  
        .pam4-eye {  
            display: flex;  
            align-items: flex-end;  
            gap: 2px;  
            height: 60px;  
            padding: 4px;  
            background: rgba(0, 0, 0, 0.4);  
            border-radius: 4px;  
            margin: 8px 0;  
        }  

        .pam4-eye .eye-bar {  
            flex: 1;  
            border-radius: 2px 2px 0 0;  
            transition: height 0.3s ease;  
            min-width: 3px;  
        }  

        /* --- Summary Card --- */  
        .summary-card {  
            background: rgba(0, 0, 0, 0.25);  
            border: 1px solid var(--border-color);  
            border-radius: var(--border-radius);  
            padding: 20px;  
            margin-top: var(--spacing-lg);  
        }  

        .summary-card h3 {  
            color: var(--accent-cyan);  
            margin-bottom: 12px;  
            font-size: 1em;  
        }  

        /* --- Transition line between steps --- */  
        .step-connector {  
            width: 2px;  
            height: 100%;  
            background: var(--border-color);  
            position: absolute;  
            left: 50%;  
            top: 0;  
            z-index: 0;  
        }  

        /* Log area */  
        .log-area {  
            background: rgba(0, 0, 0, 0.35);  
            border: 1px solid var(--border-color);  
            border-radius: var(--border-radius-sm);  
            padding: 12px;  
            max-height: 200px;  
            overflow-y: auto;  
            font-family: var(--font-mono);  
            font-size: 0.75em;  
            line-height: 1.8;  
        }  

        .log-area .log-entry {  
            animation: fadeIn 0.3s ease;  
        }  

        .log-area .log-entry .log-time {  
            color: var(--text-muted);  
            margin-right: 8px;  
        }  

        .log-area .log-entry .log-module {  
            color: var(--accent-cyan);  
            font-weight: 600;  
            margin-right: 6px;  
        }  

        /* blinking cursor for active data */  
        @keyframes blink-cursor {  
            0%, 100% { border-right-color: var(--accent-cyan); }  
            50% { border-right-color: transparent; }  
        }  

        .typing-cursor {  
            border-right: 2px solid var(--accent-cyan);  
            animation: blink-cursor 1s step-end infinite;  
            padding-right: 2px;  
        }  
    </style>  
</head>  
<body>  

<!-- ========== Page Header ========== -->  
<div class="page-header">  
    <h1>ğŸ”¬ MAC Client â†’ PMD æŠ¥æ–‡å‘é€å…¨è·¯å¾„åŠ¨ç”»</h1>  
    <div class="subtitle">  
        800GbE èŠ¯ç‰‡å†…éƒ¨ TX è·¯å¾„ Â· 11 ä¸ªå¤„ç†æ¨¡å—é€çº§æ¼”ç¤º Â· åŸºäº IEEE 802.3df &amp; UEC Specification v1.0  
    </div>  
</div>  

<!-- ========== Main Container ========== -->  
<div class="container">  

    <!-- === Controls === -->  
    <div class="section">  
        <div class="section-title">âš™ï¸ åŠ¨ç”»æ§åˆ¶</div>  

        <div class="ctrl-row">  
            <div class="form-group" style="flex:1;min-width:180px;margin-bottom:0;">  
                <label class="form-label">å¸§é•¿åº¦</label>  
                <select id="selFrameLen">  
                    <option value="64">64 å­—èŠ‚ï¼ˆæœ€å°å¸§ï¼‰</option>  
                    <option value="128">128 å­—èŠ‚</option>  
                    <option value="256" selected>256 å­—èŠ‚</option>  
                    <option value="512">512 å­—èŠ‚</option>  
                    <option value="1518">1518 å­—èŠ‚ï¼ˆæœ€å¤§æ ‡å‡†å¸§ï¼‰</option>  
                </select>  
            </div>  
            <div class="form-group" style="flex:1;min-width:180px;margin-bottom:0;">  
                <label class="form-label">LLR æ¨¡å¼</label>  
                <select id="selLLR">  
                    <option value="eligible" selected>LLR-Eligibleï¼ˆå¯é‡ä¼ ï¼‰</option>  
                    <option value="ineligible">LLR-Ineligibleï¼ˆä¸å¯é‡ä¼ ï¼‰</option>  
                    <option value="disabled">LLR æœªå¯ç”¨</option>  
                </select>  
            </div>  
            <div class="form-group" style="flex:0;min-width:120px;margin-bottom:0;">  
                <label class="form-label">åŠ¨ç”»é€Ÿåº¦</label>  
                <select id="selSpeed">  
                    <option value="0.5">0.5Ã—</option>  
                    <option value="1" selected>1Ã—</option>  
                    <option value="2">2Ã—</option>  
                    <option value="4">4Ã— å¿«é€Ÿ</option>  
                </select>  
            </div>  
        </div>  

        <div class="btn-group mt-2">  
            <button class="btn btn-primary" id="btnPlay">â–¶ è‡ªåŠ¨æ’­æ”¾</button>  
            <button class="btn btn-success" id="btnStep">â­ å•æ­¥</button>  
            <button class="btn btn-warning" id="btnReset">âŸ² é‡ç½®</button>  
        </div>  

        <div class="info-box mt-2" id="statusMsg">  
            ç‚¹å‡»ã€Œè‡ªåŠ¨æ’­æ”¾ã€æˆ–ã€Œå•æ­¥ã€å¼€å§‹è§‚å¯ŸæŠ¥æ–‡ä» MAC Client åˆ° PMD å‡ºå£çš„å®Œæ•´å¤„ç†è¿‡ç¨‹ã€‚<br>  
            æ¯ä¸€æ­¥ä¼šé«˜äº®å½“å‰æ¨¡å—ï¼Œå±•ç¤ºæ•°æ®æ ¼å¼å˜åŒ–ã€‚æŒ‰ <code>Space</code> æ’­æ”¾/æš‚åœï¼Œ<code>â†’</code> å•æ­¥ï¼Œ<code>R</code> é‡ç½®ã€‚  
        </div>  
    </div>  

    <!-- === Mini Architecture Bar === -->  
    <div class="arch-bar" id="archBar">  
        <!-- JS will populate -->  
    </div>  

    <!-- === Pipeline Modules === -->  
    <div class="pipeline" id="pipeline">  
        <!-- JS will build all modules -->  
    </div>  

    <!-- === Stats === -->  
    <div class="section">  
        <div class="section-title">ğŸ“Š ä¼ è¾“ç»Ÿè®¡</div>  
        <div class="stat-grid">  
            <div class="stat-item">  
                <div class="stat-label">å½“å‰æ¨¡å—</div>  
                <div class="stat-value" id="statModule">â€”</div>  
            </div>  
            <div class="stat-item">  
                <div class="stat-label">æ•°æ®å®½åº¦</div>  
                <div class="stat-value" id="statWidth">â€”</div>  
            </div>  
            <div class="stat-item">  
                <div class="stat-label">ç¼–ç æ•ˆç‡</div>  
                <div class="stat-value" id="statEfficiency">â€”</div>  
            </div>  
            <div class="stat-item">  
                <div class="stat-label">ç´¯è®¡å»¶è¿Ÿ</div>  
                <div class="stat-value" id="statLatency">0 ns</div>  
            </div>  
            <div class="stat-item">  
                <div class="stat-label">å¤„ç†æ­¥éª¤</div>  
                <div class="stat-value" id="statStep">0 / 11</div>  
            </div>  
            <div class="stat-item">  
                <div class="stat-label">çº¿è·¯é€Ÿç‡</div>  
                <div class="stat-value" id="statLineRate">800G</div>  
            </div>  
        </div>  
    </div>  

    <!-- === Log === -->  
    <div class="section">  
        <div class="section-title">ğŸ“‹ å¤„ç†æ—¥å¿—</div>  
        <div class="log-area" id="logArea">  
            <div class="log-entry"><span class="log-time">[00:00.000]</span><span class="log-module">SYSTEM</span> ç­‰å¾…å¯åŠ¨...</div>  
        </div>  
    </div>  

    <!-- === Summary === -->  
    <div class="summary-card" id="summaryCard" style="display:none;">  
        <h3>âœ… TX è·¯å¾„å¤„ç†å®Œæˆ</h3>  
        <div id="summaryContent"></div>  
    </div>  

    <!-- === Reference Table === -->  
    <div class="section">  
        <div class="section-title">ğŸ“š 800GbE TX è·¯å¾„å»¶è¿Ÿå‚è€ƒ</div>  
        <div class="table-wrapper">  
            <table>  
                <thead>  
                    <tr><th>æ¨¡å—</th><th>å…¸å‹å»¶è¿Ÿ</th><th>æ•°æ®æ ¼å¼</th><th>æ ‡å‡†å¼•ç”¨</th></tr>  
                </thead>  
                <tbody>  
                    <tr><td>MAC Client</td><td>20-40 ns</td><td>ä»¥å¤ªç½‘å¸§ (DA+SA+Type+Data+FCS)</td><td>IEEE 802.3 Clause 1-4</td></tr>  
                    <tr><td>CBFC (UEC)</td><td>~5 ns</td><td>ä¿¡ç”¨æ£€æŸ¥ï¼Œå¸§é€ä¼ </td><td>UEC Spec 6.11.26</td></tr>  
                    <tr><td>LLR (UEC)</td><td>~10 ns</td><td>æ·»åŠ åºåˆ—å·åˆ°å‰å¯¼ç </td><td>UEC Spec 6.11.25</td></tr>  
                    <tr><td>MAC Control</td><td>~5 ns</td><td>PAUSE/PFC å¸§æ’å…¥</td><td>IEEE 802.3 Clause 31</td></tr>  
                    <tr><td>RS (Reconciliation)</td><td>~5 ns</td><td>CGMII (TXD+TXC)</td><td>IEEE 802.3 Clause 169.3</td></tr>  
                    <tr><td>PCS (64B/66B + Scrambler + AM)</td><td>10-20 ns</td><td>66-bit å—æµ</td><td>IEEE 802.3 Clause 82/170</td></tr>  
                    <tr><td>FEC Encoder</td><td>50-100 ns</td><td>RS(544,514) ç å­—</td><td>IEEE 802.3 Clause 91/171</td></tr>  
                    <tr><td>PMA Gearbox</td><td>10-20 ns</td><td>SerDes ä½å®½é€‚é…</td><td>IEEE 802.3 Clause 169.6</td></tr>  
                    <tr><td>SerDes TX</td><td>50-100 ns</td><td>PAM4 ä¸²è¡Œæ¯”ç‰¹æµ</td><td>OIF CEI-112G</td></tr>  
                    <tr><td>PMD (E/O)</td><td>5-15 ns</td><td>å…‰ä¿¡å·</td><td>IEEE 802.3 Clause 169.7</td></tr>  
                    <tr style="font-weight:700;color:var(--accent-cyan)"><td>æ€»è®¡ (TX)</td><td>170-330 ns</td><td>â€”</td><td>â€”</td></tr>  
                </tbody>  
            </table>  
        </div>  
    </div>  

</div>  

<!-- ========== Footer ========== -->  
<div class="page-footer">  
    Mac2Pmd.html Â· 800GbE MACâ†’PMD TX å…¨è·¯å¾„åŠ¨ç”»æ¼”ç¤º<br>  
    åŸºäº IEEE 802.3df-2024 &amp; Ultra Ethernet Specification v1.0  
</div>  

<!-- ========== Scripts ========== -->  
<script src="common.js"></script>  
<script>  
(function() {  
    'use strict';  

    // ============================================================  
    //  Module Definitions â€” 11 TX processing stages  
    // ============================================================  

    const MODULES = [  
        {  
            id: 'mac_client',  
            icon: 'ğŸ“¦',  
            title: 'MAC Client â€” ä»¥å¤ªç½‘å¸§ç”Ÿæˆ',  
            layer: 'L2',  
            layerClass: '',  
            uec: false,  
            ref: 'IEEE 802.3 Clause 1-4',  
            latencyMin: 20, latencyMax: 40,  
            desc: 'ç”Ÿæˆæ ‡å‡†ä»¥å¤ªç½‘å¸§ã€‚å¸§ç»“æ„ï¼šDA(6B) + SA(6B) + Type/Len(2B) + Payload(46-1500B) + FCS(4B)ã€‚FCS ç”± CRC-32 ç®—æ³•è®¡ç®—ã€‚åŒæ—¶ç”Ÿæˆ 12 å­—èŠ‚ IPGã€‚',  
            detailFn: (ctx) => {  
                const f = ctx.frame;  
                return `<div class="pm-desc">  
                    å¸§é•¿åº¦: <b class="text-cyan">${f.totalLen} Bytes</b>ï¼ˆå« Preamble+SFD å…± ${f.totalLen + 8}Bï¼‰<br>  
                    DA: <code>${f.da}</code> &nbsp; SA: <code>${f.sa}</code> &nbsp; Type: <code>0x0800</code> &nbsp; Payload: ${f.payloadLen}B &nbsp; FCS: <code>${f.fcs}</code>  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">MAC å±‚è¾“å‡ºï¼ˆå¸§å­—èŠ‚ + IPGï¼‰</div>  
                    <div class="pm-data-box">  
                        <span class="fmt-label f-pre">PREÃ—7</span>  
                        <span class="fmt-label f-sfd">SFD</span>  
                        <span class="fmt-label f-da">DA 6B</span>  
                        <span class="fmt-label f-sa">SA 6B</span>  
                        <span class="fmt-label f-type">Type 2B</span>  
                        <span class="fmt-label f-payload">Payload ${f.payloadLen}B</span>  
                        <span class="fmt-label f-fcs">FCS 4B</span>  
                        <span class="fmt-label f-ipg">IPG 12B</span>  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>é€Ÿç‡:</b> 800 Gbps</span>  
                    <span class="info-chip"><b>å¸§å¤§å°:</b> ${f.totalLen}B</span>  
                    <span class="info-chip"><b>CRC-32:</b> ${f.fcs}</span>  
                </div>`;  
            },  
            widthLabel: '8-bit bytes',  
            efficiency: '100%',  
        },  
        {  
            id: 'cbfc',  
            icon: 'ğŸ’³',  
            title: 'CBFC â€” åŸºäºä¿¡ç”¨çš„æµæ§ (TX)',  
            layer: 'UEC',  
            layerClass: 'uec-tag',  
            uec: true,  
            ref: 'UEC Specification 6.11.26',  
            latencyMin: 3, latencyMax: 5,  
            desc: 'æ£€æŸ¥ç›®æ ‡è™šæ‹Ÿé€šé“(VC)æ˜¯å¦æœ‰è¶³å¤Ÿä¿¡ç”¨ã€‚ä¿¡ç”¨å……è¶³åˆ™é€ä¼ å¸§ï¼›ä¿¡ç”¨ä¸è¶³åˆ™é˜»å¡ç­‰å¾… CF_Updateã€‚æ¯ä¸ªæ•°æ®åŒ…æ¶ˆè€—ç›¸åº”ä¿¡ç”¨ï¼Œé€šè¿‡ CC_Update/CF_Update æ¶ˆæ¯åŒæ­¥ã€‚',  
            detailFn: (ctx) => {  
                return `<div class="pm-desc">  
                    ä¿¡ç”¨æ£€æŸ¥é€šè¿‡ âœ… â€” VC å¯ç”¨ä¿¡ç”¨å……è¶³ï¼Œå¸§é€ä¼ åˆ°ä¸‹ä¸€æ¨¡å—ã€‚<br>  
                    æ”¯æŒ 1-32 ä¸ªè™šæ‹Ÿé€šé“ï¼ŒLossless/Best-effort ä¸¤ç§æ¨¡å¼ã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">è¾“å‡ºæ ¼å¼ï¼šå¸§æ•°æ®ä¸å˜ï¼ˆé€ä¼ ï¼‰</div>  
                    <div class="pm-data-box">  
                        <span class="fmt-label f-da">DA</span>  
                        <span class="fmt-label f-sa">SA</span>  
                        <span class="fmt-label f-type">Type</span>  
                        <span class="fmt-label f-payload">Payload</span>  
                        <span class="fmt-label f-fcs">FCS</span>  
                        &nbsp; â† å¸§æ•°æ®ä¸å˜ï¼Œä»…åšä¿¡ç”¨æ‰£å‡  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>VC:</b> é»˜è®¤ VC0</span>  
                    <span class="info-chip"><b>æ“ä½œ:</b> ä¿¡ç”¨æ‰£å‡</span>  
                    <span class="info-chip"><b>CC_Update:</b> å‘¨æœŸå‘é€</span>  
                </div>`;  
            },  
            widthLabel: 'å¸§é€ä¼ ',  
            efficiency: '100%',  
        },  
        {  
            id: 'llr',  
            icon: 'ğŸ”„',  
            title: 'LLR â€” é“¾è·¯å±‚é‡ä¼  (TX)',  
            layer: 'UEC',  
            layerClass: 'uec-tag',  
            uec: true,  
            ref: 'UEC Specification 6.11.25',  
            latencyMin: 5, latencyMax: 10,  
            desc: 'LLR-Eligible å¸§ï¼šåˆ†é… 20-bit frame_seq åºåˆ—å·ï¼Œç¼–ç åˆ°å‰å¯¼ç  Byte1-3 ä¸­ï¼ˆByte1[3:0]=0x7 æ ‡è¯†eligibleï¼‰ï¼Œå¸§å­˜å…¥ Replay Buffer ç­‰å¾… ACKã€‚LLR-Ineligible å¸§ï¼šä¸åˆ†é…åºåˆ—å·ï¼Œç›´æ¥é€ä¼ ã€‚',  
            detailFn: (ctx) => {  
                const llr = ctx.llrMode;  
                if (llr === 'disabled') {  
                    return `<div class="pm-desc">LLR æœªå¯ç”¨ â€” å¸§ç›´æ¥é€ä¼ ï¼Œä½¿ç”¨æ ‡å‡† IEEE å‰å¯¼ç ã€‚</div>  
                    <div class="pm-data-view">  
                        <div class="pm-data-label">å‰å¯¼ç ï¼ˆæ ‡å‡†ï¼‰</div>  
                        <div class="pm-data-box">  
                            <span class="fmt-label f-pre">55 55 55 55 55 55 55</span>  
                            <span class="fmt-label f-sfd">D5</span>  
                            + å¸§æ•°æ®  
                        </div>  
                    </div>`;  
                }  
                if (llr === 'eligible') {  
                    const seq = ctx.frameSeq;  
                    const seqHex = seq.toString(16).toUpperCase().padStart(5, '0');  
                    const d1High = (seq >> 16) & 0xF;  
                    const d1 = ((d1High << 4) | 0x7).toString(16).toUpperCase().padStart(2, '0');  
                    const d2 = ((seq >> 8) & 0xFF).toString(16).toUpperCase().padStart(2, '0');  
                    const d3 = (seq & 0xFF).toString(16).toUpperCase().padStart(2, '0');  
                    return `<div class="pm-desc">  
                        LLR-Eligible âœ… â€” åˆ†é… frame_seq = <b class="text-cyan">0x${seqHex}</b><br>  
                        åºåˆ—å·ç¼–ç åˆ°å‰å¯¼ç  D1-D3ï¼šD1={seq[19:16],0x7}=0x${d1}, D2=0x${d2}, D3=0x${d3}<br>  
                        å¸§å­˜å…¥ Replay Bufferï¼Œç­‰å¾… ACK æˆ– NACKã€‚  
                    </div>  
                    <div class="pm-data-view">  
                        <div class="pm-data-label">å‰å¯¼ç ï¼ˆLLR-Eligibleï¼‰</div>  
                        <div class="pm-data-box">  
                            <span class="fmt-label" style="background:#ff9800;color:#000;">FB</span>  
                            <span class="fmt-label f-seq">${d1}</span>  
                            <span class="fmt-label f-seq">${d2}</span>  
                            <span class="fmt-label f-seq">${d3}</span>  
                            <span class="fmt-label f-pre">55</span>  
                            <span class="fmt-label f-pre">55</span>  
                            <span class="fmt-label f-pre">55</span>  
                            <span class="fmt-label f-sfd">D5</span>  
                            + å¸§æ•°æ® + FCS  
                        </div>  
                    </div>  
                    <div class="info-chips">  
                        <span class="info-chip"><b>frame_seq:</b> 0x${seqHex} (20-bit)</span>  
                        <span class="info-chip"><b>Byte1[3:0]:</b> 0x7 (eligible)</span>  
                        <span class="info-chip"><b>Replay Buffer:</b> å·²ç¼“å­˜</span>  
                    </div>`;  
                }  
                // ineligible  
                return `<div class="pm-desc">  
                    LLR-Ineligible â›” â€” ä¸åˆ†é…åºåˆ—å·ï¼Œå¸§ ä¸ å­˜å…¥ Replay Bufferã€‚<br>  
                    å…¸å‹å¸§ç±»å‹: Pauseå¸§ã€PFCå¸§ã€CF_Updateã€LLDPå¸§ã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">å‰å¯¼ç ï¼ˆLLR-Ineligibleï¼‰</div>  
                    <div class="pm-data-box">  
                        <span class="fmt-label" style="background:#ff9800;color:#000;">FB</span>  
                        <span class="fmt-label f-pre">55 55 55 55 55 55</span>  
                        <span class="fmt-label f-sfd">D5</span>  
                        + å¸§æ•°æ® + FCS  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>Byte1[3:0]:</b> 0x5 (ineligible)</span>  
                    <span class="info-chip"><b>Replay Buffer:</b> è·³è¿‡</span>  
                </div>`;  
            },  
            widthLabel: 'å¸§+å‰å¯¼ç ',  
            efficiency: '100%',  
        },  
        {  
            id: 'mac_ctrl',  
            icon: 'ğŸ›ï¸',  
            title: 'MAC Control â€” æµæ§ç®¡ç†',  
            layer: 'L2',  
            layerClass: '',  
            uec: false,  
            ref: 'IEEE 802.3 Clause 31',  
            latencyMin: 3, latencyMax: 5,  
            desc: 'PAUSE/PFC å¸§ç®¡ç†ã€‚è‹¥éœ€å‘é€æµæ§å¸§ï¼Œå¯åœ¨å¸§é—´éš™æ’å…¥ PAUSE å¸§ã€‚æ­£å¸¸æ•°æ®å¸§ç›´æ¥é€ä¼ ã€‚è¾“å‡ºæ¥å£: CGMII (800G: 32 lanes Ã— 64-bit @ 781.25 MHz)ã€‚',  
            detailFn: (ctx) => {  
                return `<div class="pm-desc">  
                    æ­£å¸¸æ•°æ®å¸§ â€” ç›´æ¥é€ä¼ ã€‚<br>  
                    CGMII æ¥å£ï¼šTXD[2047:0] + TXC[31:0]ï¼Œæ—¶é’Ÿ 781.25 MHzã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">CGMII è¾“å‡º</div>  
                    <div class="pm-data-box">  
                        TXD[2047:0] = å¸§æ•°æ®ï¼ˆ32 lanes Ã— 64-bit å¹¶è¡Œï¼‰<br>  
                        TXC[31:0] = æ§åˆ¶ä¿¡å·ï¼ˆæ ‡è®° /S/, /T/, /I/ ç­‰æ§åˆ¶å­—ç¬¦ï¼‰  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>æ¥å£:</b> CGMII</span>  
                    <span class="info-chip"><b>å¹¶è¡Œåº¦:</b> 32Ã—64-bit</span>  
                    <span class="info-chip"><b>æ—¶é’Ÿ:</b> 781.25 MHz</span>  
                </div>`;  
            },  
            widthLabel: 'CGMII 2048-bit',  
            efficiency: '100%',  
        },  
        {  
            id: 'rs',  
            icon: 'ğŸ”—',  
            title: 'RS â€” Reconciliation Sublayer',  
            layer: 'L1',  
            layerClass: '',  
            uec: false,  
            ref: 'IEEE 802.3 Clause 169.3/122.3',  
            latencyMin: 3, latencyMax: 5,  
            desc: 'CGMII â†’ PCS å†…éƒ¨æ¥å£é€‚é…ã€‚è¯†åˆ« /S/ (Start)ã€/T/ (Terminate)ã€/I/ (Idle) æ§åˆ¶å­—ç¬¦ã€‚å°†å¸§æ•°æ®åˆ†é…åˆ° 8 Lanes (æ¯ Lane 100G)ï¼Œæ¯ Lane æ•°æ®å®½åº¦ 128-bitã€‚DIC (Deficit Idle Count) åœ¨æ­¤å¤„è®¡ç®— IPG è¡¥å¿ã€‚',  
            detailFn: (ctx) => {  
                const f = ctx.frame;  
                const dic = DICCalculator.calculate(f.totalLen, 0, 12);  
                return `<div class="pm-desc">  
                    CGMII â†’ PCS å†…éƒ¨æ¥å£è½¬æ¢ã€‚DIC è¡¥å¿ï¼šå®é™… IPG = ${dic.actualIPG} å­—èŠ‚ã€‚<br>  
                    å°†å¸§æ‹†åˆ†ä¸º /S/ Start æ§åˆ¶å­— + Data + /T/ Terminate + IDLE åºåˆ—ã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">RS å±‚è¾“å‡ºï¼šæ§åˆ¶å­—ç¬¦æ ‡è®°</div>  
                    <div class="pm-data-box">  
                        <span class="fmt-label" style="background:#ff9800;color:#000;">/S/</span>  
                        <span class="fmt-label f-pre">Preamble</span>  
                        <span class="fmt-label f-sfd">SFD</span>  
                        <span class="fmt-label f-payload">Frame Data (${f.totalLen}B)</span>  
                        <span class="fmt-label" style="background:#ff5722;color:#fff;">/T/</span>  
                        <span class="fmt-label f-ipg">IDLE Ã—${dic.actualIPG}</span>  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>Laneæ•°:</b> 8 Ã— 100G</span>  
                    <span class="info-chip"><b>Laneå®½åº¦:</b> 128-bit</span>  
                    <span class="info-chip"><b>DIC:</b> ${dic.newDIC}</span>  
                    <span class="info-chip"><b>/T/ä½ç½®:</b> ${dic.termPosition}</span>  
                </div>`;  
            },  
            widthLabel: '8Ã—128-bit',  
            efficiency: '100%',  
        },  
        {  
            id: 'pcs',  
            icon: 'ğŸ§¬',  
            title: 'PCS â€” 64B/66B ç¼–ç  + Scrambler + AM',  
            layer: 'L1 PCS',  
            layerClass: '',  
            uec: false,  
            ref: 'IEEE 802.3 Clause 82/170',  
            latencyMin: 10, latencyMax: 20,  
            desc: 'ä¸‰ä¸ªå­æ­¥éª¤ï¼šâ‘  64B/66B ç¼–ç å™¨ â€” æ¯ 64-bit æ•°æ®â†’66-bit ç å—ï¼ˆ2-bit Sync Header + 64-bit payloadï¼‰ï¼Œæ•°æ®å— Sync=01ï¼Œæ§åˆ¶å— Sync=10ï¼›â‘¡ Scrambler â€” å¤šé¡¹å¼ G(x)=1+xÂ³â¹+xâµâ¸ å¯¹ payload æ‰°ç ï¼ˆSync Header ä¸æ‰°ç ï¼‰ï¼›â‘¢ AM Insertion â€” æ¯ 16383 å—æ’å…¥ä¸€ä¸ª 128-bit Alignment Markerï¼Œæ¯ Lane ç‹¬ç«‹ AMï¼Œå« Lane IDã€‚',  
            detailFn: (ctx) => {  
                const f = ctx.frame;  
                const llr = ctx.llrMode;  
                const dataBlocks = Math.ceil(f.totalLen / 8);  

                // Build 66B block visual  
                let startBytes;  
                if (llr === 'eligible') {  
                    const s = ctx.frameSeq;  
                    const d1 = (((s >> 16) & 0xF) << 4 | 0x7).toString(16).toUpperCase().padStart(2,'0');  
                    const d2 = ((s >> 8) & 0xFF).toString(16).toUpperCase().padStart(2,'0');  
                    const d3 = (s & 0xFF).toString(16).toUpperCase().padStart(2,'0');  
                    startBytes = `<span class="fb f-bt">78</span><span class="fb f-seq">${d1}</span><span class="fb f-seq">${d2}</span><span class="fb f-seq">${d3}</span><span class="fb f-pre">55</span><span class="fb f-pre">55</span><span class="fb f-pre">55</span><span class="fb f-sfd">D5</span>`;  
                } else {  
                    startBytes = `<span class="fb f-bt">78</span><span class="fb f-pre">55</span><span class="fb f-pre">55</span><span class="fb f-pre">55</span><span class="fb f-pre">55</span><span class="fb f-pre">55</span><span class="fb f-pre">55</span><span class="fb f-sfd">D5</span>`;  
                }  

                return `<div class="pm-desc">  
                    64B/66B ç¼–ç ï¼š1 Start Block + ${dataBlocks} Data Blocks + 1 Terminate Block + IDLE Blocks<br>  
                    ç¼–ç æ•ˆç‡ï¼š64/66 = <b class="text-cyan">96.97%</b>ã€‚Scrambler ä½¿ç”¨ 58-bit LFSR æ‰°ç ã€‚<br>  
                    AM æ¯ 16383 å—æ’å…¥ä¸€æ¬¡ï¼ˆâ‰ˆ21Î¼sï¼‰ï¼Œ8 æ¡ Virtual Lane è½®è¯¢åˆ†é…ã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">Start Block (Block Type 0x78)</div>  
                    <div class="pm-data-box">  
                        <span class="fb f-sync" style="font-weight:700;">10</span> ${startBytes}  
                    </div>  
                    <div class="pm-data-label mt-1">Data Blocks (Ã—${dataBlocks})</div>  
                    <div class="pm-data-box">  
                        <span class="fb f-sync" style="background:#2196f3;color:#fff;font-weight:700;">01</span>  
                        <span class="fb f-payload">D0</span><span class="fb f-payload">D1</span><span class="fb f-payload">D2</span><span class="fb f-payload">D3</span>  
                        <span class="fb f-payload">D4</span><span class="fb f-payload">D5</span><span class="fb f-payload">D6</span><span class="fb f-payload">D7</span>  
                        &nbsp;... Ã— ${dataBlocks}  
                    </div>  
                    <div class="pm-data-label mt-1">Terminate Block + Scrambler + AM</div>  
                    <div class="pm-data-box">  
                        <span class="fb f-sync" style="font-weight:700;">10</span>  
                        <span class="fb" style="background:#ff5722;color:#fff;">87</span>  
                        <span class="fb f-ipg">00</span>Ã—7  
                        &nbsp;â†’ Scrambler(G(x)=1+xÂ³â¹+xâµâ¸) â†’ AM(per 16383 blocks)  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>ç¼–ç ç‡:</b> 64/66 = 96.97%</span>  
                    <span class="info-chip"><b>å—æ€»æ•°:</b> ~${dataBlocks + 2}</span>  
                    <span class="info-chip"><b>AMé—´éš”:</b> 16383 blocks</span>  
                    <span class="info-chip"><b>Scrambler:</b> LFSR 58-bit</span>  
                    <span class="info-chip"><b>VL:</b> 8 Virtual Lanes</span>  
                </div>`;  
            },  
            widthLabel: '66-bit blocks',  
            efficiency: '96.97%',  
        },  
        {  
            id: 'fec',  
            icon: 'ğŸ›¡ï¸',  
            title: 'FEC â€” RS(544,514) å‰å‘çº é”™ç¼–ç ',  
            layer: 'L1 FEC',  
            layerClass: '',  
            uec: false,  
            ref: 'IEEE 802.3 Clause 91/119.2/171',  
            latencyMin: 50, latencyMax: 100,  
            desc: 'Reed-Solomon RS(544,514) over GF(2Â¹â°)ã€‚å…ˆç» Transcoder å°† 66-bit PCS å—è½¬ä¸º 10-bit FEC ç¬¦å·ã€‚æ¯ç å­— 514 ä¸ªä¿¡æ¯ç¬¦å· + 30 ä¸ªæ ¡éªŒç¬¦å· = 544 ç¬¦å·ã€‚çº é”™èƒ½åŠ›ï¼šæœ€å¤š 15 ä¸ªç¬¦å·é”™è¯¯ã€‚Pre-FEC BER â‰¤ 5Ã—10â»âµï¼ŒPost-FEC BER â‰¤ 10â»Â¹Â²ã€‚',  
            detailFn: (ctx) => {  
                return `<div class="pm-desc">  
                    Transcoder: 66-bit PCS blocks â†’ 10-bit FEC symbols â†’ ç å­—ç»„è£…<br>  
                    RS(544,514): 514 Ã— 10-bit = 5140-bit ä¿¡æ¯ + 30 Ã— 10-bit = 300-bit æ ¡éªŒ = 5440-bit ç å­—<br>  
                    ç¼–ç ç‡: <b class="text-cyan">514/544 = 94.49%</b>  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">FEC ç å­—ç»“æ„</div>  
                    <div class="pm-data-box">  
                        <span class="fmt-label f-fec-d">Data: 514 symbols (5140-bit)</span>  
                        <span class="fmt-label f-fec-p">Parity: 30 symbols (300-bit)</span>  
                        &nbsp;= 544 symbols (5440-bit) per codeword  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>ç®—æ³•:</b> RS(544,514)</span>  
                    <span class="info-chip"><b>æœ‰é™åŸŸ:</b> GF(2Â¹â°)</span>  
                    <span class="info-chip"><b>çº é”™:</b> â‰¤15 symbols</span>  
                    <span class="info-chip"><b>ç¼–ç ç‡:</b> 94.49%</span>  
                    <span class="info-chip"><b>Pre-FEC BER:</b> â‰¤5Ã—10â»âµ</span>  
                    <span class="info-chip"><b>Post-FEC BER:</b> â‰¤10â»Â¹Â²</span>  
                </div>`;  
            },  
            widthLabel: '10-bit symbols',  
            efficiency: '94.49%',  
        },  
        {  
            id: 'pma',  
            icon: 'âš™ï¸',  
            title: 'PMA â€” Gearbox & Lane Mapping',  
            layer: 'L1 PMA',  
            layerClass: '',  
            uec: false,  
            ref: 'IEEE 802.3 Clause 169.6/122.5',  
            latencyMin: 10, latencyMax: 20,  
            desc: 'PMA TX Gearbox: FEC ç å­— â†’ SerDes ä½å®½é€‚é…ã€‚æ—¶é’ŸåŸŸè½¬æ¢ã€‚Lane é¡ºåºè°ƒæ•´ä¸ Physical Lane æ˜ å°„ã€‚Lane Polarity æ§åˆ¶ã€‚æ•°æ®ä¸²è¡ŒåŒ–å‡†å¤‡ã€‚',  
            detailFn: (ctx) => {  
                let laneHtml = '';  
                for (let i = 0; i < 8; i++) {  
                    laneHtml += `<div class="lane-box${i < 4 ? ' active' : ''}">  
                        <div class="lane-id">PL${i}</div>  
                        <div>VL${i}</div>  
                        <div style="font-size:0.9em;color:var(--text-muted);">100G</div>  
                    </div>`;  
                }  
                return `<div class="pm-desc">  
                    FEC ç å­— â†’ SerDes å¹¶è¡Œä½å®½ï¼ˆ128/256-bit per laneï¼‰ã€‚<br>  
                    8 Physical Lanesï¼Œæ¯ Lane 100 Gbpsã€‚Lane ææ€§å¯è°ƒã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">Physical Lane æ˜ å°„ (8 Ã— 100G)</div>  
                    <div class="lane-vis">${laneHtml}</div>  
                    <div class="pm-data-label mt-1">è¾“å‡ºæ ¼å¼</div>  
                    <div class="pm-data-box">  
                        Per Lane: 128-bit / 256-bit parallel data â†’ SerDes input  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>Lanes:</b> 8 Physical</span>  
                    <span class="info-chip"><b>æ¯Lane:</b> 128/256-bit å¹¶è¡Œ</span>  
                    <span class="info-chip"><b>Lane Polarity:</b> å¯é…</span>  
                </div>`;  
            },  
            widthLabel: '8Ã—128-bit par.',  
            efficiency: '100%',  
        },  
        {  
            id: 'serdes',  
            icon: 'âš¡',  
            title: 'SerDes TX â€” ä¸²è¡ŒåŒ– & PAM4 è°ƒåˆ¶',  
            layer: 'L1 SerDes',  
            layerClass: '',  
            uec: false,  
            ref: 'OIF CEI-56G/112G',  
            latencyMin: 50, latencyMax: 100,  
            desc: 'ä¸‰ä¸ªå­æ­¥éª¤ï¼šâ‘  Parallel-to-Serial Converter â€” æ¯ Lane ç‹¬ç«‹ Serializerï¼›â‘¡ PAM4 Modulator â€” æ¯ç¬¦å· 2-bitï¼ˆ00â†’-3, 01â†’-1, 10â†’+1, 11â†’+3ï¼‰ï¼Œç¬¦å·é€Ÿç‡ 106.25 Gbaud/Laneï¼›â‘¢ Pre-Emphasis & FFE â€” 3-5 Tap å‰å‘å‡è¡¡å™¨è¡¥å¿ä¿¡é“æŸè€—ã€‚',  
            detailFn: (ctx) => {  
                // Generate pseudo PAM4 eye bars  
                let eyeHtml = '';  
                const levels = ['-3', '-1', '+1', '+3'];  
                const colors = ['#f44336', '#ff9800', '#4caf50', '#2196f3'];  
                for (let i = 0; i < 32; i++) {  
                    const lvl = Math.floor(Math.random() * 4);  
                    const h = 12 + lvl * 12 + Math.random() * 8;  
                    eyeHtml += `<div class="eye-bar" style="height:${h}px;background:${colors[lvl]};"></div>`;  
                }  

                return `<div class="pm-desc">  
                    å¹¶è¡Œâ†’ä¸²è¡Œè½¬æ¢ + PAM4 å››ç”µå¹³è°ƒåˆ¶ + FFE é¢„åŠ é‡ã€‚<br>  
                    8 Lanes Ã— 106.25 Gbaud Ã— 2 bit/symbol = <b class="text-cyan">800 Gbps</b>  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">PAM4 ç”µå¹³æ˜ å°„</div>  
                    <div class="pm-data-box">  
                        <span class="fmt-label f-pam4">00 â†’ -3</span>  
                        <span class="fmt-label f-pam4">01 â†’ -1</span>  
                        <span class="fmt-label f-pam4">10 â†’ +1</span>  
                        <span class="fmt-label f-pam4">11 â†’ +3</span>  
                        &nbsp; Gray ç¼–ç  Â· 106.25 Gbaud/Lane  
                    </div>  
                    <div class="pm-data-label mt-1">PAM4 ç¬¦å·åºåˆ—ç¤ºæ„ï¼ˆPer Laneï¼‰</div>  
                    <div class="pam4-eye">${eyeHtml}</div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>è°ƒåˆ¶:</b> PAM4</span>  
                    <span class="info-chip"><b>Baud:</b> 106.25 Gbaud</span>  
                    <span class="info-chip"><b>FFE:</b> 3-5 Taps</span>  
                    <span class="info-chip"><b>è¾“å‡º:</b> 800-1200 mVpp å·®åˆ†</span>  
                    <span class="info-chip"><b>TJ:</b> &lt;0.30 UI</span>  
                </div>`;  
            },  
            widthLabel: 'PAM4 serial',  
            efficiency: '~100%',  
        },  
        {  
            id: 'tx_driver',  
            icon: 'ğŸ“¡',  
            title: 'TX Driver â€” å‘é€é©±åŠ¨å™¨',  
            layer: 'L1 Analog',  
            layerClass: '',  
            uec: false,  
            ref: 'OIF CEI-112G',  
            latencyMin: 2, latencyMax: 5,  
            desc: 'å·®åˆ†è¾“å‡ºé©±åŠ¨å™¨ã€‚è¾“å‡ºæ‘†å¹… 800-1200 mVpp å¯è°ƒã€‚ç”µæ°”æ¥å£ï¼šCAUI-8 (Chip-to-Module)ã€‚å°† PAM4 ç”µä¿¡å·é©±åŠ¨åˆ° PCB Trace è¿æ¥å…‰æ¨¡å—ã€‚',  
            detailFn: (ctx) => {  
                return `<div class="pm-desc">  
                    æ¨¡æ‹Ÿé©±åŠ¨å™¨å°† PAM4 æ•°å­—ä¿¡å·è½¬ä¸ºé«˜é€Ÿå·®åˆ†ç”µä¿¡å·ã€‚<br>  
                    è¾“å‡ºé€šè¿‡ CAUI-8 ç”µæ°”æ¥å£è¿æ¥åˆ°å…‰æ¨¡å—æˆ–é“œç¼†ã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">ç”µæ°”ä¿¡å·å‚æ•°</div>  
                    <div class="pm-data-box">  
                        å·®åˆ†è¾“å‡º: 800-1200 mVpp Â· PAM4 å››ç”µå¹³ Â· 8 Lanes<br>  
                        æ¥å£: CAUI-8 Â· OIF CEI-112G è§„æ ¼  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>Swing:</b> 800-1200 mVpp</span>  
                    <span class="info-chip"><b>æ¥å£:</b> CAUI-8</span>  
                    <span class="info-chip"><b>Laneæ•°:</b> 8</span>  
                </div>`;  
            },  
            widthLabel: 'å·®åˆ†ç”µä¿¡å·',  
            efficiency: '~100%',  
        },  
        {  
            id: 'pmd',  
            icon: 'ğŸ’¡',  
            title: 'PMD â€” ç”µå…‰è½¬æ¢ & å…‰æ¨¡å—è¾“å‡º',  
            layer: 'L1 PMD',  
            layerClass: '',  
            uec: false,  
            ref: 'IEEE 802.3 Clause 169.7/122.6',  
            latencyMin: 5, latencyMax: 15,  
            desc: 'å…‰æ¨¡å—æ¥å£(OSFP/QSFP-DD800)æ¥æ”¶ CAUI-8 ç”µä¿¡å·ï¼Œé€šè¿‡ E/Oï¼ˆç”µå…‰è½¬æ¢ï¼‰å°†ç”µä¿¡å·è°ƒåˆ¶åˆ°å…‰ä¿¡å·ã€‚æ¿€å…‰å™¨ç±»å‹: VCSEL(SR)/EML(DR)/DMLã€‚å…¸å‹æ³¢é•¿: 850nm(SR)/1310nm(DR)ã€‚å…‰åŠŸç‡ 0~+5 dBmã€‚ç»å…‰çº¤ä¼ è¾“åˆ°å¯¹ç«¯ã€‚',  
            detailFn: (ctx) => {  
                return `<div class="pm-desc">  
                    ç”µä¿¡å· â†’ å…‰ä¿¡å·ã€‚ç» OSFP / QSFP-DD800 å…‰æ¨¡å—å‘é€åˆ°å…‰çº¤é“¾è·¯ã€‚<br>  
                    <b class="text-green">âœ… TX è·¯å¾„å¤„ç†å®Œæˆï¼</b> æ•°æ®å·²ä» MAC Client åˆ°è¾¾å…‰çº¤å‡ºå£ã€‚  
                </div>  
                <div class="pm-data-view">  
                    <div class="pm-data-label">å…‰ä¿¡å·è¾“å‡º</div>  
                    <div class="pm-data-box" style="background:linear-gradient(90deg,rgba(255,213,79,0.15),rgba(255,112,67,0.15));border-color:rgba(255,213,79,0.3);">  
                        <span class="fmt-label f-light">ğŸ”† 8Î» Ã— 100G å…‰ä¿¡å·</span>  
                        â†’ å…‰çº¤ (SMF/MMF)  
                        Â· åŠŸç‡: 0~+5 dBm Â· æ¶ˆå…‰æ¯”: &gt;4dB  
                    </div>  
                </div>  
                <div class="info-chips">  
                    <span class="info-chip"><b>æ¨¡å—:</b> OSFP / QSFP-DD800</span>  
                    <span class="info-chip"><b>æ¿€å…‰å™¨:</b> VCSEL/EML</span>  
                    <span class="info-chip"><b>æ³¢é•¿:</b> 850nm(SR)/1310nm(DR)</span>  
                    <span class="info-chip"><b>å…‰åŠŸç‡:</b> 0~+5 dBm</span>  
                    <span class="info-chip"><b>è·ç¦»:</b> 100m(SR)/2km(DR)/10km(FR)</span>  
                </div>`;  
            },  
            widthLabel: 'å…‰ä¿¡å·',  
            efficiency: 'â€”',  
        },  
    ];  

    // ============================================================  
    //  State  
    // ============================================================  

    let currentStep = -1;  
    let totalSteps = MODULES.length;  
    let animCtrl = null;  
    let cumulativeLatency = 0;  

    function genFrameContext() {  
        const len = parseInt(document.getElementById('selFrameLen').value);  
        const payloadLen = Math.max(46, len - 18); // 6+6+2+FCS(4)  
        const totalLen = payloadLen + 18; // without preamble  
        return {  
            frame: {  
                totalLen: totalLen,  
                payloadLen: payloadLen,  
                da: Utils.randomMAC(),  
                sa: Utils.randomMAC(),  
                fcs: '0x' + Array.from({length:4}, ()=>Math.floor(Math.random()*256).toString(16).padStart(2,'0')).join('').toUpperCase(),  
            },  
            llrMode: document.getElementById('selLLR').value,  
            frameSeq: Utils.randomInt(0, 0xFFFFF),  
        };  
    }  

    let ctx = genFrameContext();  

    // ============================================================  
    //  Build DOM  
    // ============================================================  

    function buildArchBar() {  
        const bar = document.getElementById('archBar');  
        bar.innerHTML = '';  
        MODULES.forEach((m, i) => {  
            if (i > 0) {  
                const arrow = document.createElement('span');  
                arrow.className = 'ab-arrow';  
                arrow.textContent = 'â†’';  
                bar.appendChild(arrow);  
            }  
            const block = document.createElement('div');  
            block.className = 'ab-block' + (m.uec ? ' uec-bar' : '');  
            block.id = 'ab-' + m.id;  
            block.textContent = m.title.split('â€”')[0].trim().replace(/^[^\w]*/, '').substring(0, 12);  
            block.addEventListener('click', () => {  
                scrollToModule(i);  
            });  
            bar.appendChild(block);  
        });  
    }  

    function buildPipeline() {  
        const pipeline = document.getElementById('pipeline');  
        pipeline.innerHTML = '';  

        MODULES.forEach((m, i) => {  
            // Arrow  
                        if (i > 0) {
                const arrow = document.createElement('div');
                arrow.className = 'pipe-arrow';
                arrow.id = 'arrow-' + i;
                arrow.textContent = 'â¬‡';
                pipeline.appendChild(arrow);
            }

            // Module card
            const card = document.createElement('div');
            card.className = 'pipeline-module' + (m.uec ? ' uec' : '');
            card.id = 'module-' + m.id;

            // Header
            const header = document.createElement('div');
            header.className = 'pm-header';
            header.innerHTML = `
                <span class="pm-icon">${m.icon}</span>
                <span class="pm-title">${m.title}</span>
                <span class="pm-layer ${m.layerClass}">${m.layer}</span>
                <span class="pm-status" id="status-${m.id}"></span>
            `;
            card.appendChild(header);

            // Body (initially collapsed)
            const body = document.createElement('div');
            body.className = 'pm-body';
            body.id = 'body-' + m.id;
            body.innerHTML = `
                <div class="pm-desc">${m.desc}</div>
                <div class="pm-ref">ğŸ“– ${m.ref}</div>
            `;
            card.appendChild(body);

            // Click to toggle
            header.addEventListener('click', () => {
                body.classList.toggle('open');
            });

            pipeline.appendChild(card);
        });
    }

    // ============================================================
    //  Animation Logic
    // ============================================================

    function executeStep() {
        if (currentStep >= totalSteps) {
            finishAnimation();
            return false; // stop animation
        }

        const m = MODULES[currentStep];
        const latency = (m.latencyMin + m.latencyMax) / 2;
        cumulativeLatency += latency;

        // Log
        addLog(m.title.split('â€”')[0].trim(), `å¼€å§‹å¤„ç† (å»¶è¿Ÿ ~${latency.toFixed(1)} ns)`);

        // Highlight arch bar
        document.querySelectorAll('.ab-block').forEach((el, i) => {
            el.classList.remove('active');
            if (i === currentStep) el.classList.add('active');
            if (i < currentStep) el.classList.add('done');
        });

        // Highlight arrow
        if (currentStep > 0) {
            const arrow = document.getElementById('arrow-' + currentStep);
            if (arrow) arrow.classList.add('active');
            setTimeout(() => arrow.classList.remove('active'), 400);
        }

        // Highlight module
        document.querySelectorAll('.pipeline-module').forEach(el => {
            el.classList.remove('active');
        });
        const moduleEl = document.getElementById('module-' + m.id);
        moduleEl.classList.add('active');

        // Open module body
        const bodyEl = document.getElementById('body-' + m.id);
        bodyEl.classList.add('open');

        // Update body content
        if (m.detailFn) {
            bodyEl.innerHTML = m.detailFn(ctx);
        }

        // Status icon
        const statusEl = document.getElementById('status-' + m.id);
        statusEl.textContent = 'â³';

        // Scroll to module
        Utils.scrollTo(moduleEl, 70);

        // Update stats
        document.getElementById('statModule').textContent = m.title.split('â€”')[0].trim();
        document.getElementById('statWidth').textContent = m.widthLabel;
        document.getElementById('statEfficiency').textContent = m.efficiency;
        Utils.animateNumber(document.getElementById('statLatency'), cumulativeLatency - latency, cumulativeLatency, 400, 'int');
        document.getElementById('statStep').textContent = `${currentStep + 1} / ${totalSteps}`;

        // Mark as done after short delay
        setTimeout(() => {
            statusEl.textContent = 'âœ…';
            moduleEl.classList.add('done');
            addLog(m.title.split('â€”')[0].trim(), `å¤„ç†å®Œæˆ`);
        }, 300);

        currentStep++;
        return true;
    }

    function finishAnimation() {
        addLog('SYSTEM', 'ğŸ‰ TX è·¯å¾„å¤„ç†å®Œæˆï¼æ•°æ®å·²ä» MAC Client ä¼ è¾“åˆ° PMD å…‰çº¤å‡ºå£ã€‚');
        
        // Show summary
        const summaryCard = document.getElementById('summaryCard');
        summaryCard.style.display = 'block';

        const overallEfficiency = (0.9697 * 0.9449 * 100).toFixed(2); // 64/66 * 514/544
        const summaryHtml = `
            <div class="detail-grid">
                <div class="dg-key">æ€»å»¶è¿Ÿ:</div>
                <div class="dg-val text-cyan">${cumulativeLatency.toFixed(1)} ns (${(cumulativeLatency / 1000).toFixed(2)} Î¼s)</div>
                
                <div class="dg-key">å¸§é•¿åº¦:</div>
                <div class="dg-val">${ctx.frame.totalLen} Bytes (ä¸å«å‰å¯¼ç )</div>
                
                <div class="dg-key">ç¼–ç å¼€é”€:</div>
                <div class="dg-val">64B/66B (3.03%) + RS(544,514) (5.51%) = ${(100 - parseFloat(overallEfficiency)).toFixed(2)}%</div>
                
                <div class="dg-key">æ€»ä½“ç¼–ç æ•ˆç‡:</div>
                <div class="dg-val text-green">${overallEfficiency}%</div>
                
                <div class="dg-key">ç‰©ç†å±‚é€Ÿç‡:</div>
                <div class="dg-val">800 Gbps Ã— (64/66) Ã— (514/544) â‰ˆ <b class="text-cyan">694 Gbps</b> (æœ‰æ•ˆ MAC åå)</div>
                
                <div class="dg-key">ä¼ è¾“ä»‹è´¨:</div>
                <div class="dg-val">8 Ã— 100G PAM4 å…‰ä¿¡å· (106.25 Gbaud/Lane)</div>
                
                <div class="dg-key">LLR æ¨¡å¼:</div>
                <div class="dg-val">${ctx.llrMode === 'eligible' ? 'Eligible (frame_seq = 0x' + ctx.frameSeq.toString(16).toUpperCase() + ')' : ctx.llrMode === 'ineligible' ? 'Ineligible (ä¸å­˜å…¥ Replay Buffer)' : 'Disabled'}</div>
                
                <div class="dg-key">FEC çº é”™èƒ½åŠ›:</div>
                <div class="dg-val">â‰¤15 ç¬¦å·é”™è¯¯ / ç å­— Â· BER: 5Ã—10â»âµ â†’ 10â»Â¹Â²</div>
            </div>

            <div class="info-box mt-2">
                <b>ğŸš€ å…³é”®è·¯å¾„æ€»ç»“:</b><br>
                1ï¸âƒ£ MAC Client ç”Ÿæˆä»¥å¤ªç½‘å¸§ + FCS + IPG<br>
                2ï¸âƒ£ <b class="text-purple">UEC CBFC</b>: ä¿¡ç”¨æµæ§æ£€æŸ¥<br>
                3ï¸âƒ£ <b class="text-purple">UEC LLR</b>: åºåˆ—å·ç¼–ç  (Eligible å¸§å­˜å…¥ Replay Buffer)<br>
                4ï¸âƒ£ MAC Control: PAUSE/PFC ç®¡ç†<br>
                5ï¸âƒ£ RS: CGMII â†’ PCS æ¥å£é€‚é… + DIC è®¡ç®—<br>
                6ï¸âƒ£ PCS: 64B/66B ç¼–ç  + Scrambler + AM æ’å…¥<br>
                7ï¸âƒ£ FEC: RS(544,514) ç¼–ç  (çº é”™å†—ä½™)<br>
                8ï¸âƒ£ PMA: Gearbox + Lane Mapping<br>
                9ï¸âƒ£ SerDes: å¹¶ä¸²è½¬æ¢ + PAM4 è°ƒåˆ¶ + FFE<br>
                ğŸ”Ÿ TX Driver: å·®åˆ†ç”µä¿¡å·è¾“å‡º (CAUI-8)<br>
                1ï¸âƒ£1ï¸âƒ£ PMD: E/O ç”µå…‰è½¬æ¢ â†’ å…‰çº¤ä¼ è¾“<br>
            </div>

            <div class="warning-box mt-2">
                <b>âš ï¸ æ³¨æ„äº‹é¡¹:</b><br>
                â€¢ UEC LLR Replay Buffer æ·±åº¦éœ€è¦†ç›– RTT + é‡ä¼ çª—å£<br>
                â€¢ FEC å»¶è¿Ÿ (50-100ns) å  TX æ€»å»¶è¿Ÿçš„ ~30%<br>
                â€¢ AM å¿…é¡»åœ¨ FEC ä¹‹å‰æ’å…¥ (PCS å±‚)<br>
                â€¢ PAM4 è°ƒåˆ¶å¯¹ SerDes æ—¶é’Ÿç²¾åº¦è¦æ±‚æé«˜ (Â±100 ppm)<br>
                â€¢ å…‰æ¨¡å— E/O è½¬æ¢å»¶è¿Ÿéšæ¸©åº¦æ¼‚ç§»ï¼Œéœ€ CDR è¡¥å¿
            </div>
        `;
        document.getElementById('summaryContent').innerHTML = summaryHtml;

        Utils.scrollTo(summaryCard, 60);

        if (animCtrl) animCtrl.stop();
    }

    function resetAnimation() {
        currentStep = 0;
        cumulativeLatency = 0;
        ctx = genFrameContext();

        // Clear highlights
        document.querySelectorAll('.ab-block').forEach(el => {
            el.classList.remove('active', 'done');
        });
        document.querySelectorAll('.pipeline-module').forEach(el => {
            el.classList.remove('active', 'done');
        });
        document.querySelectorAll('.pm-body').forEach(el => {
            el.classList.remove('open');
        });
        document.querySelectorAll('.pm-status').forEach(el => {
            el.textContent = '';
        });
        document.querySelectorAll('.pipe-arrow').forEach(el => {
            el.classList.remove('active');
        });

        // Reset stats
        document.getElementById('statModule').textContent = 'â€”';
        document.getElementById('statWidth').textContent = 'â€”';
        document.getElementById('statEfficiency').textContent = 'â€”';
        document.getElementById('statLatency').textContent = '0 ns';
        document.getElementById('statStep').textContent = '0 / 11';

        // Clear log
        document.getElementById('logArea').innerHTML = '<div class="log-entry"><span class="log-time">[00:00.000]</span><span class="log-module">SYSTEM</span> åŠ¨ç”»å·²é‡ç½®ï¼Œç‚¹å‡»æ’­æ”¾å¼€å§‹ã€‚</div>';

        // Hide summary
        document.getElementById('summaryCard').style.display = 'none';

        document.getElementById('statusMsg').innerHTML = 'åŠ¨ç”»å·²é‡ç½®ã€‚ç‚¹å‡»ã€Œè‡ªåŠ¨æ’­æ”¾ã€æˆ–ã€Œå•æ­¥ã€å¼€å§‹æ–°ä¸€è½®æ¼”ç¤ºã€‚';
    }

    function scrollToModule(index) {
        const m = MODULES[index];
        const el = document.getElementById('module-' + m.id);
        if (el) Utils.scrollTo(el, 70);
    }

    function addLog(module, message) {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-module">${module}</span> ${message}`;
        logArea.appendChild(entry);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // ============================================================
    //  Controls
    // ============================================================

    document.getElementById('btnPlay').addEventListener('click', () => {
        if (!animCtrl) {
            animCtrl = new AnimationController({
                stepFn: executeStep,
                interval: 1200,
                onComplete: finishAnimation
            });
        }

        if (currentStep >= totalSteps) {
            resetAnimation();
        }

        if (animCtrl.isRunning) {
            animCtrl.stop();
            document.getElementById('btnPlay').innerHTML = 'â–¶ ç»§ç»­æ’­æ”¾';
            addLog('USER', 'â¸ åŠ¨ç”»å·²æš‚åœ');
        } else {
            animCtrl.start();
            document.getElementById('btnPlay').innerHTML = 'â¸ æš‚åœ';
            addLog('USER', 'â–¶ åŠ¨ç”»å¼€å§‹æ’­æ”¾');
        }
    });

    document.getElementById('btnStep').addEventListener('click', () => {
        if (animCtrl && animCtrl.isRunning) {
            animCtrl.stop();
            document.getElementById('btnPlay').innerHTML = 'â–¶ ç»§ç»­æ’­æ”¾';
        }
        if (currentStep >= totalSteps) {
            resetAnimation();
        }
        executeStep();
    });

    document.getElementById('btnReset').addEventListener('click', () => {
        resetAnimation();
    });

    document.getElementById('selSpeed').addEventListener('change', (e) => {
        const speed = parseFloat(e.target.value);
        if (animCtrl) animCtrl.setSpeed(speed);
        addLog('USER', `åŠ¨ç”»é€Ÿåº¦è°ƒæ•´ä¸º ${speed}Ã—`);
    });

    document.getElementById('selFrameLen').addEventListener('change', () => {
        if (currentStep > 0) {
            addLog('USER', 'âš ï¸ å¸§é•¿åº¦å·²ä¿®æ”¹ï¼Œè¯·é‡ç½®åŠ¨ç”»åç”Ÿæ•ˆ');
        }
    });

    document.getElementById('selLLR').addEventListener('change', () => {
        if (currentStep > 0) {
            addLog('USER', 'âš ï¸ LLR æ¨¡å¼å·²ä¿®æ”¹ï¼Œè¯·é‡ç½®åŠ¨ç”»åç”Ÿæ•ˆ');
        }
    });

    // ============================================================
    //  Keyboard Shortcuts
    // ============================================================

    Keyboard.init();
    Keyboard.on(' ', () => {
        document.getElementById('btnPlay').click();
    });
    Keyboard.on('ArrowRight', () => {
        document.getElementById('btnStep').click();
    });
    Keyboard.on('r', () => {
        document.getElementById('btnReset').click();
    });
    Keyboard.on('R', () => {
        document.getElementById('btnReset').click();
    });

    // ============================================================
    //  Initialization
    // ============================================================

    window.addEventListener('DOMContentLoaded', () => {
        // Initialize navigation
        CommonNav.init('mac2pmd');

        // Build UI
        buildArchBar();
        buildPipeline();

        addLog('SYSTEM', 'âœ… Mac2Pmd åŠ¨ç”»æ¼”ç¤ºå·²åŠ è½½å®Œæˆ');
        addLog('SYSTEM', 'ğŸ“– å¿«æ·é”®: Space=æ’­æ”¾/æš‚åœ, â†’ =å•æ­¥, R=é‡ç½®');
    });

})();
</script>

</body>
</html>