<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAC Client â†’ PMD æŠ¥æ–‡å‘é€å…¨è·¯å¾„åŠ¨ç”»æ¼”ç¤º</title>
    <link rel="stylesheet" href="common.css">
    <style>
        /* ========== Layout Styles ========== */
        .main-layout {
            display: flex;
            gap: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .left-panel {
            width: 380px;
            flex-shrink: 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .right-content {
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
            }
            .left-panel {
                width: 100%;
                position: relative;
                top: 0;
                height: auto;
                order: -1;
            }
        }

        /* ========== Left Panel Styles ========== */
        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .control-card h3 {
            color: var(--accent-cyan);
            font-size: 1em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .format-display {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--accent-cyan);
            border-radius: var(--border-radius);
            padding: 1rem;
            min-height: 200px;
            font-family: var(--font-mono);
            font-size: 0.8em;
        }

        .format-display .format-header {
            color: var(--accent-cyan);
            font-weight: 600;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .format-display .format-content {
            line-height: 1.8;
        }

        .format-display .format-bytes {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 0.5rem 0;
        }

        .format-display .byte-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .format-display .module-indicator {
            color: var(--accent-orange);
            font-weight: 600;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* ========== Pipeline Container ========== */
        .pipeline {
            position: relative;
        }

        .pipeline-module {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            overflow: hidden;
            transition: all 0.4s ease;
            cursor: pointer;
        }

        .pipeline-module.active {
            border-color: var(--accent-cyan);
            box-shadow: var(--shadow-glow-cyan);
        }

        .pipeline-module.done {
            border-color: rgba(105, 240, 174, 0.4);
        }

        .pipeline-module.uec {
            border-left: 4px solid var(--accent-purple);
        }

        .pipeline-module .pm-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px;
            cursor: pointer;
            user-select: none;
        }

        .pipeline-module .pm-header .pm-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .pipeline-module .pm-header .pm-title {
            font-weight: 600;
            font-size: 0.95em;
            flex: 1;
        }

        .pipeline-module .pm-header .pm-layer {
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(100, 255, 218, 0.1);
            color: var(--accent-cyan);
            margin-left: 8px;
            white-space: nowrap;
        }

        .pipeline-module .pm-header .pm-layer.uec-tag {
            background: rgba(187, 134, 252, 0.15);
            color: var(--accent-purple);
        }

        .pipeline-module .pm-header .pm-status {
            font-size: 0.8em;
            margin-left: 10px;
            min-width: 20px;
            text-align: center;
        }

        .pipeline-module .pm-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding: 0 18px;
        }

        .pipeline-module .pm-body.open {
            max-height: 2000px;
            padding: 0 18px 16px;
        }

        .pipeline-module .pm-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .pipeline-module .pm-ref {
            font-size: 0.75em;
            color: var(--text-muted);
            font-style: italic;
        }

        /* --- Mini Architecture Diagram --- */
        .arch-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-lg);
        }

        .arch-bar .ab-block {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7em;
            font-weight: 600;
            white-space: nowrap;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            min-width: 65px;
        }

        .arch-bar .ab-block.active {
            border-color: var(--accent-cyan);
            background: rgba(100, 255, 218, 0.12);
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
            color: var(--accent-cyan);
        }

        .arch-bar .ab-block.done {
            border-color: rgba(105, 240, 174, 0.3);
            color: var(--accent-green);
        }

        .arch-bar .ab-block.uec-bar {
            border-color: rgba(187, 134, 252, 0.3);
        }

        .arch-bar .ab-arrow {
            color: var(--text-muted);
            font-size: 0.8em;
            flex-shrink: 0;
        }

        /* --- Flow Arrow between modules --- */
        .pipe-arrow {
            text-align: center;
            font-size: 1.1em;
            color: var(--accent-cyan);
            opacity: 0.35;
            padding: 2px 0;
            transition: opacity 0.3s ease;
        }
        .pipe-arrow.active {
            opacity: 1;
            animation: pulse-cyan 1.5s infinite;
        }

        /* --- Data Format Display --- */
        .fmt-bytes {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        .fmt-bytes .fb {
            display: inline-block;
            padding: 2px 4px;
            border-radius: 2px;
            font-family: var(--font-mono);
            font-size: 0.72em;
            min-width: 22px;
            text-align: center;
        }

        .fmt-label {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: 600;
            margin-right: 4px;
        }

        /* Specific field colors */
        .f-da     { background: #1565C0; color: #fff; }
        .f-sa     { background: #0277BD; color: #fff; }
        .f-type   { background: #00838F; color: #fff; }
        .f-payload{ background: #2196f3; color: #fff; }
        .f-fcs    { background: #f44336; color: #fff; }
        .f-pre    { background: #9c27b0; color: #fff; }
        .f-sfd    { background: #e91e63; color: #fff; }
        .f-ipg    { background: #607d8b; color: #fff; }
        .f-seq    { background: #4caf50; color: #fff; }
        .f-sync   { background: #ff9800; color: #000; }
        .f-bt     { background: #ff9800; color: #000; }
        .f-scr    { background: #6A1B9A; color: #fff; }
        .f-am     { background: #00BCD4; color: #000; }
        .f-fec-d  { background: #3F51B5; color: #fff; }
        .f-fec-p  { background: #E65100; color: #fff; }
        .f-pam4   { background: #263238; color: #69f0ae; border: 1px solid #69f0ae; }
        .f-light  { background: linear-gradient(135deg, #FFD54F, #FF7043); color: #000; }

        /* --- Info Chips --- */
        .info-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .info-chip {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(100, 255, 218, 0.08);
            border: 1px solid rgba(100, 255, 218, 0.15);
            color: var(--text-secondary);
        }

        .info-chip b {
            color: var(--accent-cyan);
        }

        /* --- Detail Table --- */
        .detail-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 12px;
            font-size: 0.82em;
            margin: 8px 0;
        }

        .detail-grid .dg-key {
            color: var(--text-muted);
            white-space: nowrap;
        }

        .detail-grid .dg-val {
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.92em;
        }

        /* --- Lane Distribution Visual --- */
        .lane-vis {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin: 8px 0;
        }

        .lane-vis .lane-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px;
            text-align: center;
            font-size: 0.65em;
            font-family: var(--font-mono);
            transition: all 0.3s ease;
        }

        .lane-vis .lane-box.active {
            border-color: var(--accent-cyan);
            background: rgba(100, 255, 218, 0.1);
        }

        .lane-vis .lane-box .lane-id {
            font-weight: 700;
            color: var(--accent-cyan);
        }

        /* --- PAM4 Eye Diagram --- */
        .pam4-eye {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 60px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            margin: 8px 0;
        }

        .pam4-eye .eye-bar {
            flex: 1;
            border-radius: 2px 2px 0 0;
            transition: height 0.3s ease;
            min-width: 3px;
        }

        /* --- Summary Card --- */
        .summary-card {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: var(--spacing-lg);
        }

        .summary-card h3 {
            color: var(--accent-cyan);
            margin-bottom: 12px;
            font-size: 1em;
        }

        /* Log area */
        .log-area {
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 12px;
            max-height: 150px;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: 0.75em;
            line-height: 1.8;
        }

        .log-area .log-entry {
            animation: fadeIn 0.3s ease;
        }

        .log-area .log-entry .log-time {
            color: var(--text-muted);
            margin-right: 8px;
        }

        .log-area .log-entry .log-module {
            color: var(--accent-cyan);
            font-weight: 600;
            margin-right: 6px;
        }
    </style>
</head>
<body>

<!-- ========== Page Header ========== -->
<div class="page-header">
    <h1>ğŸ”¬ MAC Client â†’ PMD æŠ¥æ–‡å‘é€å…¨è·¯å¾„åŠ¨ç”»</h1>
    <div class="subtitle">
        800GbE èŠ¯ç‰‡å†…éƒ¨ TX è·¯å¾„ Â· 11 ä¸ªå¤„ç†æ¨¡å—é€çº§æ¼”ç¤º Â· åŸºäº IEEE 802.3df & UEC Specification v1.0
    </div>
</div>

<!-- ========== Main Layout ========== -->
<div class="main-layout">
    
    <!-- ========== Left Panel: Controls & Format Display ========== -->
    <aside class="left-panel">
        <!-- Controls -->
        <div class="control-card">
            <h3>âš™ï¸ åŠ¨ç”»æ§åˆ¶</h3>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">å¸§é•¿åº¦</label>
                <select id="selFrameLen" class="form-control">
                    <option value="64">64 å­—èŠ‚ï¼ˆæœ€å°å¸§ï¼‰</option>
                    <option value="128">128 å­—èŠ‚</option>
                    <option value="256" selected>256 å­—èŠ‚</option>
                    <option value="512">512 å­—èŠ‚</option>
                    <option value="1518">1518 å­—èŠ‚ï¼ˆæœ€å¤§æ ‡å‡†å¸§ï¼‰</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">LLR æ¨¡å¼</label>
                <select id="selLLR" class="form-control">
                    <option value="eligible" selected>LLR-Eligibleï¼ˆå¯é‡ä¼ ï¼‰</option>
                    <option value="ineligible">LLR-Ineligibleï¼ˆä¸å¯é‡ä¼ ï¼‰</option>
                    <option value="disabled">LLR æœªå¯ç”¨</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">åŠ¨ç”»é€Ÿåº¦</label>
                <select id="selSpeed" class="form-control">
                    <option value="0.5">0.5Ã—</option>
                    <option value="1" selected>1Ã—</option>
                    <option value="2">2Ã—</option>
                    <option value="4">4Ã— å¿«é€Ÿ</option>
                </select>
            </div>

            <div class="btn-group" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-primary" id="btnPlay" style="flex: 1;">â–¶ æ’­æ”¾</button>
                <button class="btn btn-success" id="btnStep">â­</button>
                <button class="btn btn-warning" id="btnReset">âŸ²</button>
            </div>

            <div class="info-box mt-2" style="font-size: 0.8em; padding: 0.75rem;">
                <code>Space</code>=æ’­æ”¾/æš‚åœ <code>â†’</code>=å•æ­¥ <code>R</code>=é‡ç½®
            </div>
        </div>

        <!-- Real-time Format Display -->
        <div class="control-card">
            <h3>ğŸ“¦ å½“å‰æŠ¥æ–‡æ ¼å¼</h3>
            <div class="format-display" id="formatDisplay">
                <div class="format-header">ç­‰å¾…å¼€å§‹...</div>
                <div class="format-content" id="formatContent">
                    ç‚¹å‡»ã€Œæ’­æ”¾ã€æˆ–ã€Œå•æ­¥ã€å¼€å§‹åŠ¨ç”»
                </div>
                <div class="module-indicator" id="moduleIndicator">â€”</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="control-card">
            <h3>ğŸ“Š å®æ—¶ç»Ÿè®¡</h3>
            <div class="detail-grid">
                <div class="dg-key">å½“å‰æ¨¡å—:</div>
                <div class="dg-val" id="statModule">â€”</div>
                
                <div class="dg-key">æ•°æ®å®½åº¦:</div>
                <div class="dg-val" id="statWidth">â€”</div>
                
                <div class="dg-key">ç¼–ç æ•ˆç‡:</div>
                <div class="dg-val" id="statEfficiency">â€”</div>
                
                <div class="dg-key">ç´¯è®¡å»¶è¿Ÿ:</div>
                <div class="dg-val" id="statLatency">0 ns</div>
                
                <div class="dg-key">å¤„ç†æ­¥éª¤:</div>
                <div class="dg-val" id="statStep">0 / 11</div>
            </div>
        </div>

        <!-- Log -->
        <div class="control-card" style="flex: 1; display: flex; flex-direction: column;">
            <h3>ğŸ“‹ å¤„ç†æ—¥å¿—</h3>
            <div class="log-area" id="logArea" style="flex: 1;">
                <div class="log-entry"><span class="log-time">[00:00.000]</span><span class="log-module">SYSTEM</span> ç­‰å¾…å¯åŠ¨...</div>
            </div>
        </div>
    </aside>

    <!-- ========== Right Content: Animation & Details ========== -->
    <main class="right-content">
        
        <!-- Mini Architecture Bar -->
        <div class="arch-bar" id="archBar">
            <!-- JS will populate -->
        </div>

        <!-- Pipeline Modules -->
        <div class="pipeline" id="pipeline">
            <!-- JS will build all modules -->
        </div>

        <!-- Summary -->
        <div class="summary-card" id="summaryCard" style="display:none;">
            <h3>âœ… TX è·¯å¾„å¤„ç†å®Œæˆ</h3>
            <div id="summaryContent"></div>
        </div>

        <!-- Reference Table -->
        <div class="section" style="margin-top: 2rem;">
            <div class="section-title">ğŸ“š 800GbE TX è·¯å¾„å»¶è¿Ÿå‚è€ƒ</div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>æ¨¡å—</th><th>å…¸å‹å»¶è¿Ÿ</th><th>æ•°æ®æ ¼å¼</th><th>æ ‡å‡†å¼•ç”¨</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>MAC Client</td><td>20-40 ns</td><td>ä»¥å¤ªç½‘å¸§ (DA+SA+Type+Data+FCS)</td><td>IEEE 802.3 Clause 1-4</td></tr>
                        <tr><td>CBFC (UEC)</td><td>~5 ns</td><td>ä¿¡ç”¨æ£€æŸ¥ï¼Œå¸§é€ä¼ </td><td>UEC Spec 6.11.26</td></tr>
                        <tr><td>LLR (UEC)</td><td>~10 ns</td><td>æ·»åŠ åºåˆ—å·åˆ°å‰å¯¼ç </td><td>UEC Spec 6.11.25</td></tr>
                        <tr><td>MAC Control</td><td>~5 ns</td><td>PAUSE/PFC å¸§æ’å…¥</td><td>IEEE 802.3 Clause 31</td></tr>
                        <tr><td>RS (Reconciliation)</td><td>~5 ns</td><td>CGMII (TXD+TXC)</td><td>IEEE 802.3 Clause 169.3</td></tr>
                        <tr><td>PCS (64B/66B + Scrambler + AM)</td><td>10-20 ns</td><td>66-bit å—æµ</td><td>IEEE 802.3 Clause 82/170</td></tr>
                        <tr><td>FEC Encoder</td><td>50-100 ns</td><td>RS(544,514) ç å­—</td><td>IEEE 802.3 Clause 91/171</td></tr>
                        <tr><td>PMA Gearbox</td><td>10-20 ns</td><td>SerDes ä½å®½é€‚é…</td><td>IEEE 802.3 Clause 169.6</td></tr>
                        <tr><td>SerDes TX</td><td>50-100 ns</td><td>PAM4 ä¸²è¡Œæ¯”ç‰¹æµ</td><td>OIF CEI-112G</td></tr>
                        <tr><td>PMD (E/O)</td><td>5-15 ns</td><td>å…‰ä¿¡å·</td><td>IEEE 802.3 Clause 169.7</td></tr>
                        <tr style="font-weight:700;color:var(--accent-cyan)"><td>æ€»è®¡ (TX)</td><td>170-330 ns</td><td>â€”</td><td>â€”</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<!-- ========== Footer ========== -->
<div class="page-footer">
    Mac2Pmd.html Â· 800GbE MACâ†’PMD TX å…¨è·¯å¾„åŠ¨ç”»æ¼”ç¤º<br>
    åŸºäº IEEE 802.3df-2024 & Ultra Ethernet Specification v1.0
</div>

<!-- ========== Scripts ========== -->
<script src="common.js"></script>
<script>
(function() {
    'use strict';

    // ============================================================
    //  Module Definitions â€” 11 TX processing stages
    // ============================================================

    const MODULES = [
        {
            id: 'mac_client',
            icon: 'ğŸ“¦',
            title: 'MAC Client â€” ä»¥å¤ªç½‘å¸§ç”Ÿæˆ',
            layer: 'L2',
            layerClass: '',
            uec: false,
            ref: 'IEEE 802.3 Clause 1-4',
            latencyMin: 20, latencyMax: 40,
            desc: 'ç”Ÿæˆæ ‡å‡†ä»¥å¤ªç½‘å¸§ã€‚å¸§ç»“æ„ï¼šDA(6B) + SA(6B) + Type/Len(2B) + Payload(46-1500B) + FCS(4B)ã€‚FCS ç”± CRC-32 ç®—æ³•è®¡ç®—ã€‚åŒæ—¶ç”Ÿæˆ 12 å­—èŠ‚ IPGã€‚',
            formatFn: (ctx) => {
                const f = ctx.frame;
                return {
                    header: `ä»¥å¤ªç½‘å¸§ (${f.totalLen} Bytes)`,
                    content: `
<span class="byte-tag f-pre">å‰å¯¼ç  7B</span>
<span class="byte-tag f-sfd">SFD</span>
<span class="byte-tag f-da">DA ${f.da}</span>
<span class="byte-tag f-sa">SA ${f.sa}</span>
<span class="byte-tag f-type">Type</span>
<span class="byte-tag f-payload">Payload ${f.payloadLen}B</span>
<span class="byte-tag f-fcs">FCS</span>
<span class="byte-tag f-ipg">IPG 12B</span>`,
                    details: `DA: ${f.da} | SA: ${f.sa} | Payload: ${f.payloadLen}B`
                };
            },
            widthLabel: '8-bit bytes',
            efficiency: '100%',
        },
        {
            id: 'cbfc',
            icon: 'ğŸ’³',
            title: 'CBFC â€” åŸºäºä¿¡ç”¨çš„æµæ§ (TX)',
            layer: 'UEC',
            layerClass: 'uec-tag',
            uec: true,
            ref: 'UEC Specification 6.11.26',
            latencyMin: 3, latencyMax: 5,
            desc: 'æ£€æŸ¥ç›®æ ‡è™šæ‹Ÿé€šé“(VC)æ˜¯å¦æœ‰è¶³å¤Ÿä¿¡ç”¨ã€‚ä¿¡ç”¨å……è¶³åˆ™é€ä¼ å¸§ï¼›ä¿¡ç”¨ä¸è¶³åˆ™é˜»å¡ç­‰å¾… CF_Updateã€‚',
            formatFn: (ctx) => ({
                header: 'CBFC ä¿¡ç”¨æ£€æŸ¥',
                content: '<span class="byte-tag f-pre">å¸§æ•°æ®é€ä¼ </span><span style="color:var(--accent-green)">âœ“ ä¿¡ç”¨å……è¶³</span>',
                details: 'VC[0] ä¿¡ç”¨æ£€æŸ¥é€šè¿‡ï¼Œå¸§ç»§ç»­ä¼ è¾“'
            }),
            widthLabel: 'å¸§é€ä¼ ',
            efficiency: '100%',
        },
        {
            id: 'llr',
            icon: 'ğŸ”„',
            title: 'LLR â€” é“¾è·¯å±‚é‡ä¼  (TX)',
            layer: 'UEC',
            layerClass: 'uec-tag',
            uec: true,
            ref: 'UEC Specification 6.11.25',
            latencyMin: 5, latencyMax: 10,
            desc: 'LLR-Eligible å¸§ï¼šåˆ†é… 20-bit frame_seq åºåˆ—å·ï¼Œç¼–ç åˆ°å‰å¯¼ç  Byte1-3 ä¸­ï¼Œå¸§å­˜å…¥ Replay Buffer ç­‰å¾… ACKã€‚',
            formatFn: (ctx) => {
                if (ctx.llrMode === 'disabled') {
                    return { header: 'LLR æœªå¯ç”¨', content: 'æ ‡å‡†å‰å¯¼ç ', details: 'å¸§ç›´æ¥é€ä¼ ' };
                }
                if (ctx.llrMode === 'eligible') {
                    const seq = ctx.frameSeq;
                    const seqHex = seq.toString(16).toUpperCase().padStart(5, '0');
                    return {
                        header: `LLR-Eligible (Seq: 0x${seqHex})`,
                        content: `<span class="byte-tag f-bt">FB</span><span class="byte-tag f-seq">${seqHex.substring(0,2)}</span><span class="byte-tag f-seq">${seqHex.substring(2,4)}</span><span class="byte-tag f-seq">${seqHex.substring(4)}</span><span class="byte-tag f-pre">55Ã—3</span><span class="byte-tag f-sfd">D5</span>`,
                        details: `åºåˆ—å·: 0x${seqHex} | å·²å­˜å…¥ Replay Buffer`
                    };
                }
                return { header: 'LLR-Ineligible', content: 'æ— å‰å¯¼ç åºåˆ—å·', details: 'ä¸å­˜å…¥ Replay Buffer' };
            },
            widthLabel: 'å¸§+å‰å¯¼ç ',
            efficiency: '100%',
        },
        {
            id: 'mac_ctrl',
            icon: 'ğŸ›ï¸',
            title: 'MAC Control â€” æµæ§ç®¡ç†',
            layer: 'L2',
            layerClass: '',
            uec: false,
            ref: 'IEEE 802.3 Clause 31',
            latencyMin: 3, latencyMax: 5,
            desc: 'PAUSE/PFC å¸§ç®¡ç†ã€‚æ­£å¸¸æ•°æ®å¸§ç›´æ¥é€ä¼ ã€‚è¾“å‡ºæ¥å£: CGMII (32 lanes Ã— 64-bit)ã€‚',
            formatFn: (ctx) => ({
                header: 'CGMII æ¥å£è¾“å‡º',
                content: '<span class="byte-tag">TXD[2047:0]</span><span class="byte-tag">TXC[31:0]</span>',
                details: '32 lanes Ã— 64-bit @ 781.25 MHz'
            }),
            widthLabel: 'CGMII 2048-bit',
            efficiency: '100%',
        },
        {
            id: 'rs',
            icon: 'ğŸ”—',
            title: 'RS â€” Reconciliation Sublayer',
            layer: 'L1',
            layerClass: '',
            uec: false,
            ref: 'IEEE 802.3 Clause 169.3/122.3',
            latencyMin: 3, latencyMax: 5,
            desc: 'CGMII â†’ PCS å†…éƒ¨æ¥å£é€‚é…ã€‚è¯†åˆ« /S/ /T/ /I/ æ§åˆ¶å­—ç¬¦ã€‚è®¡ç®— DICã€‚',
            formatFn: (ctx) => {
                const f = ctx.frame;
                const dic = DICCalculator.calculate(f.totalLen, 0, 12);
                return {
                    header: 'RS å±‚è¾“å‡º (/S/ /T/ æ ‡è®°)',
                    content: '<span class="byte-tag f-sync">/S/</span><span class="byte-tag f-pre">Preamble</span><span class="byte-tag f-payload">Data</span><span class="byte-tag" style="background:#ff5722">/T/</span><span class="byte-tag f-ipg">IDLE</span>',
                    details: `DIC=${dic.newDIC} | /T/ä½ç½®=${dic.termPosition} | å®é™…IPG=${dic.actualIPG}B`
                };
            },
            widthLabel: '8Ã—128-bit',
            efficiency: '100%',
        },
        {
            id: 'pcs',
            icon: 'ğŸ§¬',
            title: 'PCS â€” 64B/66B ç¼–ç  + Scrambler + AM',
            layer: 'L1 PCS',
            layerClass: '',
            uec: false,
            ref: 'IEEE 802.3 Clause 82/170',
            latencyMin: 10, latencyMax: 20,
            desc: '64B/66B ç¼–ç å™¨ + Scrambler (G(x)=1+xÂ³â¹+xâµâ¸) + AM Insertionã€‚',
            formatFn: (ctx) => {
                const dataBlocks = Math.ceil(ctx.frame.totalLen / 8);
                return {
                    header: '64B/66B å—æµ',
                    content: `<span class="byte-tag f-sync">10</span><span class="byte-tag f-bt">Start</span> + ${dataBlocks}Ã—<span class="byte-tag" style="background:#2196f3">01 Data</span> + <span class="byte-tag f-sync">10</span><span class="byte-tag" style="background:#ff5722">Term</span>`,
                    details: `ç¼–ç æ•ˆç‡: 96.97% | å—æ•°: ~${dataBlocks + 2} | AMé—´éš”: 16383 blocks`
                };
            },
            widthLabel: '66-bit blocks',
            efficiency: '96.97%',
        },
        {
            id: 'fec',
            icon: 'ğŸ›¡ï¸',
            title: 'FEC â€” RS(544,514) å‰å‘çº é”™ç¼–ç ',
            layer: 'L1 FEC',
            layerClass: '',
            uec: false,
            ref: 'IEEE 802.3 Clause 91/119.2/171',
            latencyMin: 50, latencyMax: 100,
            desc: 'Reed-Solomon RS(544,514) over GF(2Â¹â°)ã€‚514 ä¿¡æ¯ç¬¦å· + 30 æ ¡éªŒç¬¦å·ã€‚',
            formatFn: (ctx) => ({
                header: 'RS(544,514) ç å­—',
                content: '<span class="byte-tag f-fec-d">Data: 514 sym</span><span class="byte-tag f-fec-p">Parity: 30 sym</span>',
                details: 'ç¼–ç ç‡: 94.49% | çº é”™èƒ½åŠ›: â‰¤15 symbols | BER: 5Ã—10â»âµ â†’ 10â»Â¹Â²'
            }),
            widthLabel: '10-bit symbols',
            efficiency: '94.49%',
        },
        {
            id: 'pma',
            icon: 'âš™ï¸',
            title: 'PMA â€” Gearbox & Lane Mapping',
            layer: 'L1 PMA',
            layerClass: '',
            uec: false,
            ref: 'IEEE 802.3 Clause 169.6/122.5',
            latencyMin: 10, latencyMax: 20,
            desc: 'PMA TX Gearbox: FEC ç å­— â†’ SerDes ä½å®½é€‚é…ã€‚Lane æ˜ å°„ã€‚',
            formatFn: (ctx) => ({
                header: 'PMA Gearbox è¾“å‡º',
                content: '<span class="byte-tag">PL0</span><span class="byte-tag">PL1</span><span class="byte-tag">PL2</span><span class="byte-tag">PL3</span><span class="byte-tag">PL4</span><span class="byte-tag">PL5</span><span class="byte-tag">PL6</span><span class="byte-tag">PL7</span>',
                details: '8 Physical Lanes Ã— 128/256-bit å¹¶è¡Œ â†’ SerDes'
            }),
            widthLabel: '8Ã—128-bit par.',
            efficiency: '100%',
        },
        {
            id: 'serdes',
            icon: 'âš¡',
            title: 'SerDes TX â€” ä¸²è¡ŒåŒ– & PAM4 è°ƒåˆ¶',
            layer: 'L1 SerDes',
            layerClass: '',
            uec: false,
            ref: 'OIF CEI-56G/112G',
            latencyMin: 50, latencyMax: 100,
            desc: 'Parallel-to-Serial + PAM4 Modulator (00â†’-3, 01â†’-1, 10â†’+1, 11â†’+3) + FFEã€‚',
            formatFn: (ctx) => ({
                header: 'PAM4 ä¸²è¡Œä¿¡å·',
                content: '<span class="byte-tag f-pam4">00â†’-3</span><span class="byte-tag f-pam4">01â†’-1</span><span class="byte-tag f-pam4">10â†’+1</span><span class="byte-tag f-pam4">11â†’+3</span>',
                details: '106.25 Gbaud/Lane Ã— 8 Lanes = 800 Gbps | Grayç¼–ç '
            }),
            widthLabel: 'PAM4 serial',
            efficiency: '~100%',
        },
        {
            id: 'tx_driver',
            icon: 'ğŸ“¡',
            title: 'TX Driver â€” å‘é€é©±åŠ¨å™¨',
            layer: 'L1 Analog',
            layerClass: '',
            uec: false,
            ref: 'OIF CEI-112G',
            latencyMin: 2, latencyMax: 5,
            desc: 'å·®åˆ†è¾“å‡ºé©±åŠ¨å™¨ã€‚è¾“å‡ºæ‘†å¹… 800-1200 mVppã€‚CAUI-8 æ¥å£ã€‚',
            formatFn: (ctx) => ({
                header: 'CAUI-8 å·®åˆ†ä¿¡å·',
                content: '<span class="byte-tag">800-1200mVpp</span><span class="byte-tag">PAM4</span><span class="byte-tag">8 Lanes</span>',
                details: 'ç”µæ°”æ¥å£: CAUI-8 | è¾“å‡ºæ‘†å¹…å¯è°ƒ | FFEé¢„åŠ é‡'
            }),
            widthLabel: 'å·®åˆ†ç”µä¿¡å·',
            efficiency: '~100%',
        },
        {
            id: 'pmd',
            icon: 'ğŸ’¡',
            title: 'PMD â€” ç”µå…‰è½¬æ¢ & å…‰æ¨¡å—è¾“å‡º',
            layer: 'L1 PMD',
            layerClass: '',
            uec: false,
            ref: 'IEEE 802.3 Clause 169.7/122.6',
            latencyMin: 5, latencyMax: 15,
            desc: 'OSFP/QSFP-DD800 å…‰æ¨¡å— E/O è½¬æ¢ã€‚VCSEL/EML æ¿€å…‰å™¨ã€‚',
            formatFn: (ctx) => ({
                header: 'ğŸ”† å…‰ä¿¡å·è¾“å‡º',
                content: '<span class="byte-tag f-light">8Î» Ã— 100G</span>',
                details: 'å…‰åŠŸç‡: 0~+5 dBm | æ³¢é•¿: 850nm/1310nm | æ¶ˆå…‰æ¯”: >4dB'
            }),
            widthLabel: 'å…‰ä¿¡å·',
            efficiency: 'â€”',
        },
    ];

    // ============================================================
    //  State
    // ============================================================

    let currentStep = -1;
    let totalSteps = MODULES.length;
    let animCtrl = null;
    let cumulativeLatency = 0;

    function genFrameContext() {
        const len = parseInt(document.getElementById('selFrameLen').value);
        const payloadLen = Math.max(46, len - 18);
        const totalLen = payloadLen + 18;
        return {
            frame: {
                totalLen: totalLen,
                payloadLen: payloadLen,
                da: Utils.randomMAC(),
                sa: Utils.randomMAC(),
                fcs: '0x' + Array.from({length:4}, ()=>Math.floor(Math.random()*256).toString(16).padStart(2,'0')).join('').toUpperCase(),
            },
            llrMode: document.getElementById('selLLR').value,
            frameSeq: Utils.randomInt(0, 0xFFFFF),
        };
    }

    let ctx = genFrameContext();

    // ============================================================
    //  Update Format Display
    // ============================================================

    function updateFormatDisplay(moduleIndex) {
        const display = document.getElementById('formatDisplay');
        const header = display.querySelector('.format-header');
        const content = display.querySelector('.format-content');
        const indicator = display.querySelector('.module-indicator');

        if (moduleIndex < 0 || moduleIndex >= MODULES.length) {
            header.textContent = 'ç­‰å¾…å¼€å§‹...';
            content.innerHTML = 'ç‚¹å‡»ã€Œæ’­æ”¾ã€æˆ–ã€Œå•æ­¥ã€å¼€å§‹åŠ¨ç”»';
            indicator.textContent = 'â€”';
            return;
        }

        const m = MODULES[moduleIndex];
        const format = m.formatFn(ctx);

        header.textContent = format.header;
        content.innerHTML = '<div class="format-bytes">' + format.content + '</div>';
        if (format.details) {
            content.innerHTML += '<div style="margin-top:0.75rem;color:var(--text-secondary);">' + format.details + '</div>';
        }
        indicator.textContent = `å½“å‰æ¨¡å—: ${m.title.split('â€”')[0].trim()}`;
    }

    // ============================================================
    //  Build DOM
    // ============================================================

    function buildArchBar() {
        const bar = document.getElementById('archBar');
        bar.innerHTML = '';
        MODULES.forEach((m, i) => {
            if (i > 0) {
                const arrow = document.createElement('span');
                arrow.className = 'ab-arrow';
                arrow.textContent = 'â†’';
                bar.appendChild(arrow);
            }
            const block = document.createElement('div');
            block.className = 'ab-block' + (m.uec ? ' uec-bar' : '');
            block.id = 'ab-' + m.id;
            block.textContent = m.title.split('â€”')[0].trim().replace(/^[^\w]*/, '').substring(0, 12);
            block.addEventListener('click', () => {
                scrollToModule(i);
            });
            bar.appendChild(block);
        });
    }

    function buildPipeline() {
        const pipeline = document.getElementById('pipeline');
        pipeline.innerHTML = '';

        MODULES.forEach((m, i) => {
            if (i > 0) {
                const arrow = document.createElement('div');
                arrow.className = 'pipe-arrow';
                arrow.id = 'arrow-' + i;
                arrow.textContent = 'â¬‡';
                pipeline.appendChild(arrow);
            }

            const card = document.createElement('div');
            card.className = 'pipeline-module' + (m.uec ? ' uec' : '');
            card.id = 'module-' + m.id;

            const header = document.createElement('div');
            header.className = 'pm-header';
            header.innerHTML = `
                <span class="pm-icon">${m.icon}</span>
                <span class="pm-title">${m.title}</span>
                <span class="pm-layer ${m.layerClass}">${m.layer}</span>
                <span class="pm-status" id="status-${m.id}"></span>
            `;
            card.appendChild(header);

            const body = document.createElement('div');
            body.className = 'pm-body';
            body.id = 'body-' + m.id;
            body.innerHTML = `
                <div class="pm-desc">${m.desc}</div>
                <div class="pm-ref">ğŸ“– ${m.ref}</div>
            `;
            card.appendChild(body);

            header.addEventListener('click', () => {
                body.classList.toggle('open');
            });

            pipeline.appendChild(card);
        });
    }

    // ============================================================
    //  Animation Logic
    // ============================================================

    function executeStep() {
        if (currentStep >= totalSteps) {
            finishAnimation();
            return false;
        }

        const m = MODULES[currentStep];
        const latency = (m.latencyMin + m.latencyMax) / 2;
        cumulativeLatency += latency;

        addLog(m.title.split('â€”')[0].trim(), `å¼€å§‹å¤„ç† (å»¶è¿Ÿ ~${latency.toFixed(1)} ns)`);

        // Update format display
        updateFormatDisplay(currentStep);

        // Highlight arch bar
        document.querySelectorAll('.ab-block').forEach((el, i) => {
            el.classList.remove('active');
            if (i === currentStep) el.classList.add('active');
            if (i < currentStep) el.classList.add('done');
        });

        // Highlight arrow
        if (currentStep > 0) {
            const arrow = document.getElementById('arrow-' + currentStep);
            if (arrow) arrow.classList.add('active');
            setTimeout(() => arrow && arrow.classList.remove('active'), 400);
        }

        // Highlight module
        document.querySelectorAll('.pipeline-module').forEach(el => el.classList.remove('active'));
        const moduleEl = document.getElementById('module-' + m.id);
        moduleEl.classList.add('active');

        // Scroll to module
        Utils.scrollTo(moduleEl, 100);

        // Update stats
        document.getElementById('statModule').textContent = m.title.split('â€”')[0].trim();
        document.getElementById('statWidth').textContent = m.widthLabel;
        document.getElementById('statEfficiency').textContent = m.efficiency;
        Utils.animateNumber(document.getElementById('statLatency'), cumulativeLatency - latency, cumulativeLatency, 400, 'int');
        document.getElementById('statStep').textContent = `${currentStep + 1} / ${totalSteps}`;

        // Status
        const statusEl = document.getElementById('status-' + m.id);
        statusEl.textContent = 'â³';

        setTimeout(() => {
            statusEl.textContent = 'âœ…';
            moduleEl.classList.add('done');
            addLog(m.title.split('â€”')[0].trim(), 'å¤„ç†å®Œæˆ');
        }, 300);

        currentStep++;
        return true;
    }

    function finishAnimation() {
        addLog('SYSTEM', 'ğŸ‰ TX è·¯å¾„å¤„ç†å®Œæˆï¼');
        
        const summaryCard = document.getElementById('summaryCard');
        summaryCard.style.display = 'block';

        const overallEfficiency = (0.9697 * 0.9449 * 100).toFixed(2);
        document.getElementById('summaryContent').innerHTML = `
            <div class="detail-grid">
                <div class="dg-key">æ€»å»¶è¿Ÿ:</div>
                <div class="dg-val text-cyan">${cumulativeLatency.toFixed(1)} ns</div>
                <div class="dg-key">æ€»ä½“ç¼–ç æ•ˆç‡:</div>
                <div class="dg-val text-green">${overallEfficiency}%</div>
                <div class="dg-key">æœ‰æ•ˆ MAC åå:</div>
                <div class="dg-val">â‰ˆ 694 Gbps</div>
            </div>
        `;

        updateFormatDisplay(totalSteps - 1);
        Utils.scrollTo(summaryCard, 100);
        if (animCtrl) animCtrl.stop();
    }

    function resetAnimation() {
        currentStep = 0;
        cumulativeLatency = 0;
        ctx = genFrameContext();

        document.querySelectorAll('.ab-block').forEach(el => el.classList.remove('active', 'done'));
        document.querySelectorAll('.pipeline-module').forEach(el => el.classList.remove('active', 'done'));
        document.querySelectorAll('.pm-status').forEach(el => el.textContent = '');
        document.querySelectorAll('.pipe-arrow').forEach(el => el.classList.remove('active'));

        document.getElementById('statModule').textContent = 'â€”';
        document.getElementById('statWidth').textContent = 'â€”';
        document.getElementById('statEfficiency').textContent = 'â€”';
        document.getElementById('statLatency').textContent = '0 ns';
        document.getElementById('statStep').textContent = '0 / 11';

        document.getElementById('logArea').innerHTML = '<div class="log-entry"><span class="log-time">[00:00.000]</span><span class="log-module">SYSTEM</span> åŠ¨ç”»å·²é‡ç½®</div>';
        document.getElementById('summaryCard').style.display = 'none';

        updateFormatDisplay(-1);
    }

    function scrollToModule(index) {
        const m = MODULES[index];
        const el = document.getElementById('module-' + m.id);
        if (el) Utils.scrollTo(el, 100);
    }

    function addLog(module, message) {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-module">${module}</span> ${message}`;
        logArea.appendChild(entry);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // ============================================================
    //  Controls
    // ============================================================

    document.getElementById('btnPlay').addEventListener('click', () => {
        if (!animCtrl) {
            animCtrl = new AnimationController({
                stepFn: executeStep,
                interval: 1200,
                onComplete: finishAnimation
            });
        }

        if (currentStep >= totalSteps) {
            resetAnimation();
        }

        if (animCtrl.isRunning) {
            animCtrl.stop();
            document.getElementById('btnPlay').innerHTML = 'â–¶ æ’­æ”¾';
            addLog('USER', 'â¸ æš‚åœ');
        } else {
            animCtrl.start();
            document.getElementById('btnPlay').innerHTML = 'â¸ æš‚åœ';
            addLog('USER', 'â–¶ æ’­æ”¾');
        }
    });

    document.getElementById('btnStep').addEventListener('click', () => {
        if (animCtrl && animCtrl.isRunning) {
            animCtrl.stop();
            document.getElementById('btnPlay').innerHTML = 'â–¶ æ’­æ”¾';
        }
        if (currentStep >= totalSteps) {
            resetAnimation();
        }
        executeStep();
    });

    document.getElementById('btnReset').addEventListener('click', () => {
        resetAnimation();
        addLog('USER', 'âŸ² é‡ç½®');
    });

    document.getElementById('selSpeed').addEventListener('change', (e) => {
        const speed = parseFloat(e.target.value);
        if (animCtrl) animCtrl.setSpeed(speed);
    });

    // ============================================================
    //  Keyboard Shortcuts
    // ============================================================

    Keyboard.init();
    Keyboard.on(' ', () => document.getElementById('btnPlay').click());
    Keyboard.on('ArrowRight', () => document.getElementById('btnStep').click());
    Keyboard.on('r', () => document.getElementById('btnReset').click());
    Keyboard.on('R', () => document.getElementById('btnReset').click());

    // ============================================================
    //  Initialization
    // ============================================================

    window.addEventListener('DOMContentLoaded', () => {
        CommonNav.init('mac2pmd', [
            { id: 'index', label: 'ç›®å½•', file: 'index.html' },
            { id: 'cbfc', label: 'PFC vs CBFC', file: 'CBFCvsBFC.html' },
            { id: 'mac2pmd', label: 'MACâ†’PMD', file: 'Mac2Pmd.html' }
        ]);

        buildArchBar();
        buildPipeline();
        updateFormatDisplay(-1);

        addLog('SYSTEM', 'âœ… Mac2Pmd åŠ¨ç”»æ¼”ç¤ºå·²åŠ è½½');
    });

})();
</script>

</body>
</html>
