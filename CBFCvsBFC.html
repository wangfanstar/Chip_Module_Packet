<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBFC vs BFC â€” ä¿¡ç”¨æµæ§ vs åŸºç¡€æµæ§ å¯¹æ¯”åˆ†æ</title>
    <link rel="stylesheet" href="common.css">
    <style>
        /* ---- Page-specific Styles ---- */
        .section-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            transition: all var(--transition-normal);
        }
        .section-card:hover {
            border-color: var(--border-color-hover);
            box-shadow: var(--shadow-card-hover);
        }
        .section-card h2 {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }
        .section-card h3 {
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            color: var(--accent-cyan);
        }

        /* ---- Comparison Grid ---- */
        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }
        @media (max-width: 768px) {
            .compare-grid { grid-template-columns: 1fr; }
        }

        .compare-box {
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            position: relative;
            overflow: hidden;
        }
        .compare-box.cbfc {
            background: rgba(100, 255, 218, 0.05);
            border: 2px solid rgba(100, 255, 218, 0.25);
        }
        .compare-box.bfc {
            background: rgba(255, 171, 64, 0.05);
            border: 2px solid rgba(255, 171, 64, 0.25);
        }
        .compare-box .box-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .compare-box.cbfc .box-title { color: var(--accent-cyan); }
        .compare-box.bfc .box-title { color: var(--accent-orange); }
        .compare-box .box-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.65em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .compare-box.cbfc .box-badge {
            background: rgba(100, 255, 218, 0.15);
            color: var(--accent-cyan);
        }
        .compare-box.bfc .box-badge {
            background: rgba(255, 171, 64, 0.15);
            color: var(--accent-orange);
        }
        .compare-box ul {
            list-style: none;
            padding: 0;
        }
        .compare-box ul li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        .compare-box ul li::before {
            content: 'â–¸';
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        .compare-box.cbfc ul li::before { color: var(--accent-cyan); }
        .compare-box.bfc ul li::before { color: var(--accent-orange); }

        /* ---- Animation Canvas Area ---- */
        .anim-canvas {
            position: relative;
            width: 100%;
            height: 420px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin: var(--spacing-md) 0;
        }
        .anim-canvas svg {
            width: 100%;
            height: 100%;
        }

        /* ---- Device Boxes in SVG ---- */
        .device-label {
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 600;
        }
        .counter-label {
            font-family: var(--font-mono);
            font-size: 11px;
        }
        .counter-value {
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 700;
        }
        .msg-label {
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
        }

        /* ---- Packet Animation ---- */
        .pkt-dot {
            transition: none;
        }
        @keyframes pktMove {
            0% { opacity: 1; }
            100% { opacity: 1; }
        }

        /* ---- Architecture Diagram ---- */
        .arch-diagram {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
        }
        .arch-row {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
        }
        .arch-block {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: center;
            min-width: 130px;
            transition: all var(--transition-normal);
            position: relative;
        }
        .arch-block:hover {
            border-color: var(--accent-cyan);
            box-shadow: var(--shadow-glow-cyan);
        }
        .arch-block .arch-name {
            font-weight: 700;
            font-size: 0.95em;
            color: var(--accent-cyan);
        }
        .arch-block .arch-desc {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .arch-block.highlight-cbfc {
            border-color: var(--accent-cyan);
            background: rgba(100, 255, 218, 0.08);
        }
        .arch-block.highlight-bfc {
            border-color: var(--accent-orange);
            background: rgba(255, 171, 64, 0.08);
        }
        .arch-arrow {
            font-size: 1.4em;
            color: var(--accent-cyan);
            flex-shrink: 0;
        }
        .arch-arrow-down {
            text-align: center;
            font-size: 1.4em;
            color: var(--accent-cyan);
        }

        /* ---- Feature Tag ---- */
        .feature-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
            margin: 2px;
        }
        .tag-cbfc {
            background: rgba(100, 255, 218, 0.12);
            color: var(--accent-cyan);
            border: 1px solid rgba(100, 255, 218, 0.3);
        }
        .tag-bfc {
            background: rgba(255, 171, 64, 0.12);
            color: var(--accent-orange);
            border: 1px solid rgba(255, 171, 64, 0.3);
        }
        .tag-both {
            background: rgba(187, 134, 252, 0.12);
            color: var(--accent-purple);
            border: 1px solid rgba(187, 134, 252, 0.3);
        }

        /* ---- Scenario Cards ---- */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }
        .scenario-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            transition: all var(--transition-normal);
        }
        .scenario-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-3px);
            box-shadow: var(--shadow-glow-cyan);
        }
        .scenario-card .scenario-icon {
            font-size: 2em;
            margin-bottom: var(--spacing-sm);
        }
        .scenario-card .scenario-title {
            font-size: 1.05em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        .scenario-card .scenario-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        .scenario-card .scenario-tags {
            margin-top: var(--spacing-md);
        }

        /* ---- Control Panel ---- */
        .ctrl-panel {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-md);
        }

        /* ---- Step Log ---- */
        .step-log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md);
            max-height: 180px;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: 0.8em;
            line-height: 1.8;
        }
        .step-log .log-entry {
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }
        .step-log .log-entry.cbfc-msg { color: var(--accent-cyan); }
        .step-log .log-entry.bfc-msg { color: var(--accent-orange); }
        .step-log .log-entry.data-msg { color: var(--accent-blue); }
        .step-log .log-entry.warn-msg { color: var(--accent-yellow); }
        .step-log .log-entry .log-time {
            color: var(--text-muted);
            margin-right: 8px;
        }

        /* ---- Versus Badge ---- */
        .vs-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-btn-primary);
            color: #fff;
            font-weight: 900;
            font-size: 1em;
            flex-shrink: 0;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }

        /* ---- Highlight Row ---- */
        .highlight-row {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            justify-content: center;
            margin: var(--spacing-xl) 0;
        }

        /* ---- Buffer Visualization ---- */
        .buffer-viz {
            display: flex;
            gap: 3px;
            align-items: flex-end;
            height: 60px;
            padding: var(--spacing-sm);
            background: rgba(0,0,0,0.2);
            border-radius: var(--border-radius-sm);
        }
        .buffer-cell {
            width: 18px;
            border-radius: 2px;
            transition: height 0.3s ease, background 0.3s ease;
        }
        .buffer-cell.empty {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid rgba(100, 255, 218, 0.2);
        }
        .buffer-cell.used-vc0 { background: var(--accent-cyan); }
        .buffer-cell.used-vc1 { background: var(--accent-purple); }
        .buffer-cell.used-vc2 { background: var(--accent-blue); }
        .buffer-cell.used-be  { background: var(--accent-orange); }

        /* ---- Timeline ---- */
        .timeline-bar {
            position: relative;
            height: 8px;
            background: rgba(100, 255, 218, 0.1);
            border-radius: 4px;
            margin: var(--spacing-md) 0;
            overflow: hidden;
        }
        .timeline-progress {
            height: 100%;
            background: var(--gradient-btn-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>

<!-- ====== Navigation Bar ====== -->
<div class="nav-bar">
    <a class="nav-back" href="index.html">â† è¿”å›ç›®å½•</a>
</div>

<!-- ====== Page Header ====== -->
<div class="page-header">
    <h1>CBFC vs BFC â€” æµæ§æœºåˆ¶æ·±åº¦å¯¹æ¯”</h1>
    <p class="subtitle">Credit-Based Flow Control vs Basic Flow Control (PFC/PAUSE) â€” åŠ¨ç”»æ¼”ç¤º Â· æ¶æ„è®¾è®¡ Â· åº”ç”¨åœºæ™¯</p>
    <p class="subtitle" style="font-size:0.8em; margin-top:6px; opacity:0.6;">åŸºäº Ultra Ethernet Specification v1.0 Â§ 5.2</p>
</div>

<!-- ====== Main Content ====== -->
<div class="container" id="main-tabs">

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab="tab-overview">æ¦‚è§ˆå¯¹æ¯”</button>
        <button class="tab-btn" data-tab="tab-anim-cbfc">CBFC åŠ¨ç”»</button>
        <button class="tab-btn" data-tab="tab-anim-bfc">BFC åŠ¨ç”»</button>
        <button class="tab-btn" data-tab="tab-arch">æ¶æ„è®¾è®¡</button>
        <button class="tab-btn" data-tab="tab-scenarios">åº”ç”¨åœºæ™¯</button>
        <button class="tab-btn" data-tab="tab-detail">æŠ€æœ¯ç»†èŠ‚</button>
    </div>

    <!-- ========================== TAB 1: æ¦‚è§ˆå¯¹æ¯” ========================== -->
    <div class="tab-content active" id="tab-overview">

        <div class="highlight-row">
            <div style="text-align:center;">
                <span class="feature-tag tag-cbfc" style="font-size:1.1em; padding:6px 18px;">CBFC</span>
                <p style="font-size:0.75em; color:var(--text-muted); margin-top:4px;">Credit-Based Flow Control</p>
            </div>
            <div class="vs-badge">VS</div>
            <div style="text-align:center;">
                <span class="feature-tag tag-bfc" style="font-size:1.1em; padding:6px 18px;">BFC</span>
                <p style="font-size:0.75em; color:var(--text-muted); margin-top:4px;">Basic Flow Control (PFC/PAUSE)</p>
            </div>
        </div>

        <div class="section-card">
            <h2>âš¡ æ ¸å¿ƒå·®å¼‚ä¸€è§ˆ</h2>

            <div class="compare-grid">
                <div class="compare-box cbfc">
                    <div class="box-title">
                        ğŸ¯ CBFC <span class="box-badge">UE Spec Â§5.2</span>
                    </div>
                    <ul>
                        <li><strong>ä¿¡ç”¨é©±åŠ¨ï¼š</strong>å‘é€æ–¹ä»…åœ¨æ‹¥æœ‰è¶³å¤Ÿä¿¡ç”¨ï¼ˆcreditsï¼‰æ—¶æ‰å…è®¸å‘é€æ•°æ®åŒ…</li>
                        <li><strong>ç²¾ç»†ç²’åº¦ï¼š</strong>æ”¯æŒå¤šè¾¾ 32 ä¸ªè™šæ‹Ÿé€šé“ï¼ˆVCsï¼‰ï¼Œæ¯ä¸ª VC ç‹¬ç«‹æ§åˆ¶</li>
                        <li><strong>åŒè®¡æ•°å™¨æœºåˆ¶ï¼š</strong>CCï¼ˆCredit Consumedï¼‰å’Œ CFï¼ˆCredit Freedï¼‰å¾ªç¯è®¡æ•°å™¨å®ç°å¯é è¿½è¸ª</li>
                        <li><strong>ä¸¤ç§æ¶ˆæ¯ç±»å‹ï¼š</strong>CF_Updateï¼ˆCtlOS 8Bï¼Œé«˜é¢‘ç‡ï¼‰å’Œ CC_Updateï¼ˆPacket 64Bï¼Œä½é¢‘ç‡ï¼‰</li>
                        <li><strong>ä¸æ•æ„Ÿäºçº¿ç¼†é•¿åº¦ï¼š</strong>çº¿ç¼†å»¶è¿Ÿä¼°ç®—é”™è¯¯ä»…å¯¼è‡´é“¾è·¯åˆ©ç”¨ç‡é™ä½ï¼Œä¸ä¼šä¸¢åŒ…</li>
                        <li><strong>çµæ´»ç¼“å†²åˆ†é…ï¼š</strong>ä½ååé‡ VC å¯åˆ†é…æ›´å°‘ä¿¡ç”¨ï¼ŒèŠ‚çœç¼“å†²ç©ºé—´</li>
                        <li><strong>ä¸ LLR ååŒï¼š</strong>å¯ä¸é“¾è·¯çº§é‡ä¼ ï¼ˆLLRï¼‰é…åˆç¡®ä¿é›¶ä¸¢åŒ…</li>
                    </ul>
                </div>
                <div class="compare-box bfc">
                    <div class="box-title">
                        ğŸ›‘ BFC (PFC/PAUSE) <span class="box-badge">IEEE 802.1Q/802.3</span>
                    </div>
                    <ul>
                        <li><strong>é˜ˆå€¼é©±åŠ¨ï¼š</strong>å½“æ¥æ”¶æ–¹ç¼“å†²åŒºæ·±åº¦è¶…è¿‡é˜ˆå€¼æ—¶å‘é€ XOFF æš‚åœä¿¡å·</li>
                        <li><strong>ä¼˜å…ˆçº§çº§åˆ«ï¼š</strong>PFC åŸºäº 8 ä¸ªä¼˜å…ˆçº§ç±»ï¼ˆTraffic Classï¼‰ï¼ŒPAUSE ä¸ºå…¨ç«¯å£æš‚åœ</li>
                        <li><strong>XOFF/XON æœºåˆ¶ï¼š</strong>ç®€å•çš„æš‚åœ/æ¢å¤äºŒçŠ¶æ€æµæ§</li>
                        <li><strong>å•ä¸€æ¶ˆæ¯ç±»å‹ï¼š</strong>PFC å¸§ (EtherType 0x8808) æºå¸¦å„ä¼˜å…ˆçº§çš„æš‚åœæ—¶é—´</li>
                        <li><strong>å¯¹å»¶è¿Ÿæ•æ„Ÿï¼š</strong>çº¿ç¼†å»¶è¿Ÿä½ä¼°å¯èƒ½å¯¼è‡´ç¼“å†²åŒºæº¢å‡ºå’Œä¸¢åŒ…</li>
                        <li><strong>ç¼“å†²å…±äº«ä¼˜åŠ¿ï¼š</strong>å¯æ›´é«˜æ•ˆåœ°åœ¨ç«¯å£é—´å…±äº«çªå‘å¸æ”¶ç¼“å†²</li>
                        <li><strong>é›¶æ¶ˆæ¯å¼€é”€ï¼š</strong>æ— æµæ§äº‹ä»¶æ—¶å¯å®Œå…¨åˆ©ç”¨é“¾è·¯å¸¦å®½</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ“Š å…³é”®å‚æ•°å¯¹æ¯”</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ç‰¹æ€§ç»´åº¦</th>
                            <th style="color:var(--accent-cyan)">CBFCï¼ˆä¿¡ç”¨æµæ§ï¼‰</th>
                            <th style="color:var(--accent-orange)">BFCï¼ˆPFC/PAUSEï¼‰</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>è§„èŒƒæ¥æº</td>
                            <td>Ultra Ethernet Spec v1.0 Â§5.2</td>
                            <td>IEEE 802.1Q-2022 Clause 36 / IEEE 802.3 Annex 31B</td>
                        </tr>
                        <tr>
                            <td>æµæ§ç²’åº¦</td>
                            <td>Per-VCï¼ˆæœ€å¤š 32 ä¸ªè™šæ‹Ÿé€šé“ï¼‰</td>
                            <td>PFC: Per-Priorityï¼ˆ8 ä¼˜å…ˆçº§ï¼‰/ PAUSE: å…¨ç«¯å£</td>
                        </tr>
                        <tr>
                            <td>æ§åˆ¶æ–¹å¼</td>
                            <td>ä¿¡ç”¨åˆ¶ â€” é¢„å…ˆæˆæƒå‘é€é‡</td>
                            <td>é˜ˆå€¼åˆ¶ â€” è¶…é˜ˆå€¼ååå‹æš‚åœ</td>
                        </tr>
                        <tr>
                            <td>æ¶ˆæ¯æ ¼å¼</td>
                            <td>CF_Update: CtlOS (8B)ï¼›CC_Update: Packet (64B)</td>
                            <td>PFC: MAC Control Frame (64B)ï¼›PAUSE: MAC Control Frame</td>
                        </tr>
                        <tr>
                            <td>å‘é€æ–¹æ„ŸçŸ¥</td>
                            <td>âœ… å‘é€æ–¹çŸ¥é“æ¯ä¸ª VC çš„ä¿¡ç”¨ä½¿ç”¨æƒ…å†µ</td>
                            <td>âŒ å‘é€æ–¹ä»…çŸ¥é“æ˜¯å¦è¢«æš‚åœ</td>
                        </tr>
                        <tr>
                            <td>çº¿ç¼†æ•æ„Ÿæ€§</td>
                            <td>ä½ â€” å»¶è¿Ÿä¼°ç®—é”™è¯¯ä»…é™ä½åˆ©ç”¨ç‡</td>
                            <td>é«˜ â€” å»¶è¿Ÿä½ä¼°å¯èƒ½å¯¼è‡´ç¼“å†²æº¢å‡ºä¸¢åŒ…</td>
                        </tr>
                        <tr>
                            <td>å®ç°å¤æ‚åº¦</td>
                            <td>é«˜ â€” éœ€è¦å¾ªç¯è®¡æ•°å™¨ã€ä¿¡ç”¨ç®¡ç†ã€LLDP TLV åå•†</td>
                            <td>ä½ â€” XOFF/XON é€»è¾‘ç®€å•</td>
                        </tr>
                        <tr>
                            <td>å¸¦å®½å¼€é”€</td>
                            <td>CF_Update < 0.5% BW; CC_Update < 0.01% BW</td>
                            <td>æ— æµæ§äº‹ä»¶æ—¶é›¶å¼€é”€</td>
                        </tr>
                        <tr>
                            <td>æ— æŸä¿è¯</td>
                            <td>âœ… ä¿¡ç”¨ä¸è¶³æ—¶ä¸å‘é€ï¼Œå¤©ç„¶æ— æŸ</td>
                            <td>âš ï¸ ä¾èµ–é˜ˆå€¼è®¾ç½®æ­£ç¡®å’Œå“åº”åŠæ—¶</td>
                        </tr>
                        <tr>
                            <td>ç¼“å†²åŒºåˆ©ç”¨ç‡</td>
                            <td>å¯ç²¾ç»†åˆ†é…ï¼Œä½åå VC ä½¿ç”¨æ›´å°‘ç¼“å†²</td>
                            <td>æ›´å¥½çš„ç«¯å£é—´ç¼“å†²å…±äº«èƒ½åŠ›</td>
                        </tr>
                        <tr>
                            <td>æ­»é”é˜²æŠ¤</td>
                            <td>æ¯ VC å‰å‘è¿›å±•ä¿è¯</td>
                            <td>éœ€è¦å¤–éƒ¨æœºåˆ¶ï¼ˆå¦‚ä¼˜å…ˆçº§è§„åˆ’ï¼‰</td>
                        </tr>
                        <tr>
                            <td>è°ƒåº¦æ”¯æŒ</td>
                            <td>âœ… å¯åˆ©ç”¨ä¿¡ç”¨ä¿¡æ¯è¿›è¡Œè°ƒåº¦ã€è´Ÿè½½å‡è¡¡ã€è‡ªé€‚åº”è·¯ç”±</td>
                            <td>æœ‰é™</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ”„ å·¥ä½œåŸç†å¯¹æ¯”ç¤ºæ„</h2>
            <div class="compare-grid">
                <div class="compare-box cbfc">
                    <div class="box-title">CBFC â€” ä¿¡ç”¨é©±åŠ¨æµç¨‹</div>
                    <div style="font-size:0.88em; line-height:2;">
                        <p><code>1.</code> åˆå§‹åŒ–ï¼šReceiver é€šè¿‡ LLDP å‘ŠçŸ¥ Sender å¯ç”¨ä¿¡ç”¨ (TotalCredits)</p>
                        <p><code>2.</code> å‘é€ï¼šSender æ£€æŸ¥ VC ä¿¡ç”¨ â†’ æœ‰ä¿¡ç”¨ â†’ å‘é€æ•°æ®åŒ… â†’ CC++</p>
                        <p><code>3.</code> æ¥æ”¶ï¼šReceiver ç¼“å†²æ•°æ® â†’ å¤„ç†åé‡Šæ”¾ç¼“å†² â†’ CF++</p>
                        <p><code>4.</code> å½’è¿˜ï¼šReceiver å‘é€ CF_Update (CtlOS) â†’ Sender æ›´æ–° CF è®¡æ•°</p>
                        <p><code>5.</code> åŒæ­¥ï¼šSender å‘¨æœŸæ€§å‘é€ CC_Update â†’ Receiver æ ¸å¯¹æ¢å¤æ³„æ¼ä¿¡ç”¨</p>
                        <p><code>6.</code> æ— ä¿¡ç”¨ â†’ Sender æš‚åœè¯¥ VC å‘é€ï¼Œå…¶ä»– VC ä¸å—å½±å“</p>
                    </div>
                </div>
                <div class="compare-box bfc">
                    <div class="box-title">BFC (PFC) â€” é˜ˆå€¼é©±åŠ¨æµç¨‹</div>
                    <div style="font-size:0.88em; line-height:2;">
                        <p><code>1.</code> æ­£å¸¸çŠ¶æ€ï¼šSender è‡ªç”±å‘é€æ•°æ®</p>
                        <p><code>2.</code> æ‹¥å¡å‘ç”Ÿï¼šReceiver ç¼“å†²åŒºé˜Ÿåˆ—æ·±åº¦è¶…è¿‡é˜ˆå€¼</p>
                        <p><code>3.</code> åå‹ï¼šReceiver å‘é€ PFC XOFF å¸§ (å«æš‚åœæ—¶é—´é‡å­)</p>
                        <p><code>4.</code> æš‚åœï¼šSender æš‚åœå¯¹åº”ä¼˜å…ˆçº§çš„æ‰€æœ‰æµé‡</p>
                        <p><code>5.</code> æ¢å¤ï¼šæš‚åœæ—¶é—´åˆ°æœŸ æˆ– Receiver å‘é€ XON å¸§</p>
                        <p><code>6.</code> é£é™©ï¼šå¦‚æœ Sender å“åº”ä¸åŠæ—¶ â†’ ç¼“å†²æº¢å‡º â†’ ä¸¢åŒ…</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================== TAB 2: CBFC åŠ¨ç”» ========================== -->
    <div class="tab-content" id="tab-anim-cbfc">
        <div class="section-card">
            <h2>ğŸ¬ CBFC ä¿¡ç”¨æµæ§äº¤äº’åŠ¨ç”»</h2>
            <p style="color:var(--text-secondary); margin-bottom:var(--spacing-md);">
                å±•ç¤º Sender å’Œ Receiver ä¹‹é—´åŸºäºä¿¡ç”¨çš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼ŒåŒ…å« CC/CF è®¡æ•°å™¨æ›´æ–°ã€VC ä¿¡ç”¨ç®¡ç†å’Œæ¶ˆæ¯äº¤äº’ã€‚
            </p>

            <div class="ctrl-panel">
                <button class="btn btn-primary" id="cbfc-play-btn" onclick="cbfcAnim.toggle()">â–¶ æ’­æ”¾</button>
                <button class="btn btn-outline" onclick="cbfcAnim.step()">â­ å•æ­¥</button>
                <button class="btn btn-outline" onclick="cbfcAnim.reset()">â†º é‡ç½®</button>
                <label style="font-size:0.85em; color:var(--text-secondary);">
                    é€Ÿåº¦: <input type="range" min="1" max="5" value="2" style="width:100px; display:inline-block;"
                                onchange="cbfcAnim.setSpeed(parseFloat(this.value))">
                </label>
            </div>

            <!-- Stats -->
            <div class="stat-grid" style="margin-bottom:var(--spacing-lg);">
                <div class="stat-item">
                    <div class="stat-label">Sender CC[0]</div>
                    <div class="stat-value" id="cbfc-s-cc">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Sender CF[0]</div>
                    <div class="stat-value" id="cbfc-s-cf" style="color:var(--accent-green)">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Available Credits</div>
                    <div class="stat-value" id="cbfc-avail" style="color:var(--accent-purple)">16</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">CreditLimit</div>
                    <div class="stat-value" id="cbfc-cl" style="color:var(--accent-yellow)">16</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Receiver CC[0]</div>
                    <div class="stat-value" id="cbfc-r-cc" style="color:var(--accent-blue)">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Receiver CF[0]</div>
                    <div class="stat-value" id="cbfc-r-cf" style="color:var(--accent-orange)">0</div>
                </div>
            </div>

            <!-- Animation SVG -->
            <div class="anim-canvas" id="cbfc-canvas">
                <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                    <!-- Sender -->
                    <rect x="30" y="120" width="180" height="160" rx="12" fill="rgba(100,255,218,0.08)" stroke="#64ffda" stroke-width="2"/>
                    <text x="120" y="148" text-anchor="middle" class="device-label" fill="#64ffda">SENDER</text>
                    <text x="50" y="172" class="counter-label" fill="#8892b0">VC[0] Queue:</text>
                    <rect x="50" y="178" width="140" height="14" rx="3" fill="rgba(0,0,0,0.3)" stroke="rgba(100,255,218,0.2)" stroke-width="1"/>
                    <rect x="50" y="178" width="0" height="14" rx="3" fill="#4fc3f7" id="cbfc-sender-q"/>
                    <text x="50" y="210" class="counter-label" fill="#8892b0">S_CC[0]: <tspan id="cbfc-svg-scc" fill="#64ffda" font-weight="700">0</tspan></text>
                    <text x="50" y="228" class="counter-label" fill="#8892b0">S_CF[0]: <tspan id="cbfc-svg-scf" fill="#69f0ae" font-weight="700">0</tspan></text>
                    <text x="50" y="248" class="counter-label" fill="#8892b0">Avail:   <tspan id="cbfc-svg-avail" fill="#bb86fc" font-weight="700">16</tspan></text>
                    <text x="50" y="268" class="counter-label" fill="#8892b0">Credit Limit: <tspan fill="#ffd740" font-weight="700">16</tspan></text>

                    <!-- Receiver -->
                    <rect x="590" y="120" width="180" height="160" rx="12" fill="rgba(100,255,218,0.08)" stroke="#64ffda" stroke-width="2"/>
                    <text x="680" y="148" text-anchor="middle" class="device-label" fill="#64ffda">RECEIVER</text>
                    <text x="610" y="172" class="counter-label" fill="#8892b0">Input Buffer:</text>
                    <g id="cbfc-rx-buffer">
                        <!-- Buffer cells drawn by JS -->
                    </g>
                    <text x="610" y="228" class="counter-label" fill="#8892b0">R_CC[0]: <tspan id="cbfc-svg-rcc" fill="#4fc3f7" font-weight="700">0</tspan></text>
                    <text x="610" y="248" class="counter-label" fill="#8892b0">R_CF[0]: <tspan id="cbfc-svg-rcf" fill="#ffab40" font-weight="700">0</tspan></text>

                    <!-- Link -->
                    <line x1="210" y1="185" x2="590" y2="185" stroke="rgba(100,255,218,0.2)" stroke-width="2" stroke-dasharray="6,4"/>
                    <line x1="210" y1="215" x2="590" y2="215" stroke="rgba(255,171,64,0.2)" stroke-width="2" stroke-dasharray="6,4"/>
                    <text x="400" y="178" text-anchor="middle" class="msg-label" fill="#8892b0">â†’ Data Packets + CC_Update â†’</text>
                    <text x="400" y="230" text-anchor="middle" class="msg-label" fill="#8892b0">â† CF_Update (CtlOS 8B) â†</text>

                    <!-- Animated packets group -->
                    <g id="cbfc-packets"></g>
                </svg>
            </div>

            <!-- Step Log -->
            <h4 style="margin-top:var(--spacing-lg)">ğŸ“‹ äº‹ä»¶æ—¥å¿—</h4>
            <div class="step-log" id="cbfc-log"></div>

            <!-- Timeline -->
            <div style="margin-top:var(--spacing-md);">
                <div style="display:flex; justify-content:space-between; font-size:0.75em; color:var(--text-muted);">
                    <span>Step 0</span>
                    <span id="cbfc-step-label">Step 0 / 40</span>
                    <span>Step 40</span>
                </div>
                <div class="timeline-bar">
                    <div class="timeline-progress" id="cbfc-progress" style="width:0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================== TAB 3: BFC åŠ¨ç”» ========================== -->
    <div class="tab-content" id="tab-anim-bfc">
        <div class="section-card">
            <h2>ğŸ¬ BFC (PFC) é˜ˆå€¼æµæ§äº¤äº’åŠ¨ç”»</h2>
            <p style="color:var(--text-secondary); margin-bottom:var(--spacing-md);">
                å±•ç¤ºä¼ ç»Ÿ PFC åŸºäºé˜ˆå€¼çš„æµé‡æ§åˆ¶è¿‡ç¨‹ï¼ŒåŒ…å« XOFF/XON ä¿¡å·äº¤äº’å’Œç¼“å†²åŒºçŠ¶æ€å˜åŒ–ã€‚
            </p>

            <div class="ctrl-panel">
                <button class="btn btn-warning" id="bfc-play-btn" onclick="bfcAnim.toggle()">â–¶ æ’­æ”¾</button>
                <button class="btn btn-outline" onclick="bfcAnim.step()">â­ å•æ­¥</button>
                <button class="btn btn-outline" onclick="bfcAnim.reset()">â†º é‡ç½®</button>
                <label style="font-size:0.85em; color:var(--text-secondary);">
                    é€Ÿåº¦: <input type="range" min="1" max="5" value="2" style="width:100px; display:inline-block;"
                                onchange="bfcAnim.setSpeed(parseFloat(this.value))">
                </label>
            </div>

            <!-- Stats -->
            <div class="stat-grid" style="margin-bottom:var(--spacing-lg);">
                <div class="stat-item">
                    <div class="stat-label">Buffer Used</div>
                    <div class="stat-value" id="bfc-buf-used" style="color:var(--accent-orange)">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Buffer Total</div>
                    <div class="stat-value" id="bfc-buf-total" style="color:var(--accent-yellow)">16</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">XOFF Threshold</div>
                    <div class="stat-value" id="bfc-threshold" style="color:var(--accent-red)">12</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Sender State</div>
                    <div class="stat-value" id="bfc-sender-state" style="color:var(--accent-green); font-size:0.9em;">SENDING</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Packets Sent</div>
                    <div class="stat-value" id="bfc-pkts-sent">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Packets Dropped</div>
                    <div class="stat-value" id="bfc-pkts-drop" style="color:var(--accent-red)">0</div>
                </div>
            </div>

            <!-- Animation SVG -->
            <div class="anim-canvas" id="bfc-canvas">
                <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                    <!-- Sender -->
                    <rect x="30" y="120" width="180" height="160" rx="12" fill="rgba(255,171,64,0.06)" stroke="#ffab40" stroke-width="2"/>
                    <text x="120" y="148" text-anchor="middle" class="device-label" fill="#ffab40">SENDER</text>
                    <text x="50" y="175" class="counter-label" fill="#8892b0">State: <tspan id="bfc-svg-state" fill="#69f0ae" font-weight="700">SENDING</tspan></text>
                    <text x="50" y="198" class="counter-label" fill="#8892b0">Pkts Sent: <tspan id="bfc-svg-sent" fill="#4fc3f7" font-weight="700">0</tspan></text>
                    <text x="50" y="221" class="counter-label" fill="#8892b0">Pkts Dropped: <tspan id="bfc-svg-drop" fill="#ff5252" font-weight="700">0</tspan></text>
                    <rect x="50" y="238" width="140" height="24" rx="4" fill="rgba(0,0,0,0.3)" stroke="rgba(255,171,64,0.3)" id="bfc-sender-indicator"/>
                    <text x="120" y="254" text-anchor="middle" class="counter-label" id="bfc-sender-bar-text" fill="#69f0ae">â— ACTIVE</text>

                    <!-- Receiver -->
                    <rect x="590" y="120" width="180" height="160" rx="12" fill="rgba(255,171,64,0.06)" stroke="#ffab40" stroke-width="2"/>
                    <text x="680" y="148" text-anchor="middle" class="device-label" fill="#ffab40">RECEIVER</text>
                    <text x="610" y="175" class="counter-label" fill="#8892b0">Buffer:</text>
                    <!-- Buffer bar -->
                    <rect x="610" y="180" width="140" height="20" rx="4" fill="rgba(0,0,0,0.3)" stroke="rgba(255,171,64,0.2)" stroke-width="1"/>
                    <rect x="610" y="180" width="0" height="20" rx="4" fill="#ffab40" id="bfc-rx-buf-bar"/>
                    <!-- Threshold line -->
                    <line x1="715" y1="178" x2="715" y2="202" stroke="#ff5252" stroke-width="2" stroke-dasharray="3,2"/>
                    <text x="718" y="176" class="msg-label" fill="#ff5252">XOFF</text>
                    <text x="610" y="220" class="counter-label" fill="#8892b0">Used: <tspan id="bfc-svg-used" fill="#ffab40" font-weight="700">0</tspan> / 16</text>
                    <text x="610" y="240" class="counter-label" fill="#8892b0">Drain Rate: <tspan fill="#69f0ae" font-weight="700">~1 pkt/step</tspan></text>

                    <!-- Link -->
                    <line x1="210" y1="185" x2="590" y2="185" stroke="rgba(255,171,64,0.2)" stroke-width="2" stroke-dasharray="6,4"/>
                    <line x1="210" y1="215" x2="590" y2="215" stroke="rgba(255,82,82,0.2)" stroke-width="2" stroke-dasharray="6,4"/>
                    <text x="400" y="178" text-anchor="middle" class="msg-label" fill="#8892b0">â†’ Data Packets â†’</text>
                    <text x="400" y="230" text-anchor="middle" class="msg-label" fill="#8892b0">â† PFC XOFF/XON â†</text>

                    <!-- Animated packets -->
                    <g id="bfc-packets"></g>
                </svg>
            </div>

            <h4 style="margin-top:var(--spacing-lg)">ğŸ“‹ äº‹ä»¶æ—¥å¿—</h4>
            <div class="step-log" id="bfc-log"></div>

            <div style="margin-top:var(--spacing-md);">
                <div style="display:flex; justify-content:space-between; font-size:0.75em; color:var(--text-muted);">
                    <span>Step 0</span>
                    <span id="bfc-step-label">Step 0 / 40</span>
                    <span>Step 40</span>
                </div>
                <div class="timeline-bar">
                    <div class="timeline-progress" id="bfc-progress" style="width:0%"></div>
                </div>
            </div>

            <div class="warning-box" style="margin-top:var(--spacing-lg)">
                <strong>âš ï¸ æ³¨æ„ï¼š</strong>åœ¨ BFC/PFC æ¨¡å¼ä¸‹ï¼Œå¦‚æœå‘é€æ–¹å“åº” XOFF ä¸åŠæ—¶ï¼ˆä¾‹å¦‚çº¿ç¼†å»¶è¿Ÿè¢«ä½ä¼°ï¼‰ï¼Œæ¥æ”¶æ–¹ç¼“å†²åŒºå¯èƒ½æº¢å‡ºå¯¼è‡´ä¸¢åŒ…ã€‚
                è¿™æ­£æ˜¯ CBFC çš„ä¼˜åŠ¿æ‰€åœ¨ â€” å‘é€æ–¹åœ¨å‘é€å‰å·²ç»çŸ¥é“æ¥æ”¶æ–¹æ˜¯å¦æœ‰è¶³å¤Ÿç¼“å†²ã€‚
            </div>
        </div>
    </div>

    <!-- ========================== TAB 4: æ¶æ„è®¾è®¡ ========================== -->
    <div class="tab-content" id="tab-arch">
        <div class="section-card">
            <h2>ğŸ—ï¸ CBFC æ¶æ„åœ¨ Ethernet å±‚æ¨¡å‹ä¸­çš„ä½ç½®</h2>
            <p style="color:var(--text-secondary); margin-bottom:var(--spacing-lg);">
                CBFC ä¸»è¦åœ¨æ•°æ®é“¾è·¯å±‚å®ç°ï¼Œä½†éœ€è¦ MACã€RSã€PCS å­å±‚çš„é…åˆä¿®æ”¹æ¥æ­£ç¡®ä¼ é€’ CtlOS æ¶ˆæ¯ã€‚(UE Spec Figure 5-7)
            </p>

            <div class="arch-diagram">
                <div class="arch-row">
                    <div class="arch-block">
                        <div class="arch-name">Upper Layers</div>
                        <div class="arch-desc">MAC Client</div>
                    </div>
                </div>
                <div class="arch-arrow-down">â†•</div>
                <div class="arch-row">
                    <div class="arch-block highlight-cbfc">
                        <div class="arch-name">CBFC Layer</div>
                        <div class="arch-desc">ä¿¡ç”¨ç®¡ç† / CC+CF è®¡æ•°å™¨</div>
                        <span class="feature-tag tag-cbfc" style="margin-top:6px">UE Extension</span>
                    </div>
                    <div class="arch-arrow">âŸ·</div>
                    <div class="arch-block highlight-bfc">
                        <div class="arch-name">PFC (BFC)</div>
                        <div class="arch-desc">XOFF/XON æ§åˆ¶</div>
                        <span class="feature-tag tag-bfc" style="margin-top:6px">IEEE 802.1Q</span>
                    </div>
                </div>
                <div class="arch-arrow-down">â†•</div>
                <div class="arch-row">
                    <div class="arch-block">
                        <div class="arch-name">MAC Control</div>
                        <div class="arch-desc">MA_DATA / MA_CONTROL</div>
                    </div>
                </div>
                <div class="arch-arrow-down">â†•</div>
                <div class="arch-row">
                    <div class="arch-block">
                        <div class="arch-name">MAC</div>
                        <div class="arch-desc">CtlOS æ’å…¥/æå–</div>
                    </div>
                </div>
                <div class="arch-arrow-down">â†•</div>
                <div class="arch-row">
                    <div class="arch-block">
                        <div class="arch-name">RS (Reconciliation)</div>
                        <div class="arch-desc">xMII æ¥å£</div>
                    </div>
                </div>
                <div class="arch-arrow-down">â†•</div>
                <div class="arch-row">
                    <div class="arch-block">
                        <div class="arch-name">PCS (64B/66B)</div>
                        <div class="arch-desc">O-code=0x6 for CtlOS</div>
                    </div>
                    <div class="arch-arrow">â†’</div>
                    <div class="arch-block">
                        <div class="arch-name">FEC + PMA + PMD</div>
                        <div class="arch-desc">Physical Medium</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <strong>â„¹ï¸ å…³é”®è®¾è®¡ç‚¹ï¼š</strong>CBFC å’Œ PFC å¯ä»¥åŒæ—¶è¿è¡Œåœ¨åŒä¸€é“¾è·¯ä¸Šã€‚CBFC ç®¡ç†ä¸»è¾“å…¥ç¼“å†²åŒºï¼ŒPFC ç®¡ç†å¦ä¸€ä¸ªç¼“å†²ç‚¹æˆ–æ¯åŒ…èµ„æºã€‚
                ä¸¤è€…äº’ä¸å¹²æ‰°ï¼Œä½† PFC æ§åˆ¶åŒ…å¿…é¡»æ˜¯ LLR-ineligible ä¸”å±äº best-effort VCã€‚
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ“ CBFC æ¶ˆæ¯æ¶æ„</h2>
            <div class="compare-grid">
                <div class="module-box">
                    <div class="module-header">CF_Update â€” ä¿¡ç”¨é‡Šæ”¾æ¶ˆæ¯</div>
                    <div class="module-ref">Receiver â†’ Sender | CtlOS æ ¼å¼ | 8 Bytes</div>
                    <div class="module-detail">
                        <p>â€¢ <strong>æ–¹å‘ï¼š</strong>æ¥æ”¶æ–¹ â†’ å‘é€æ–¹</p>
                        <p>â€¢ <strong>æ ¼å¼ï¼š</strong>Control Ordered Set (CtlOS)ï¼Œ8 å­—èŠ‚</p>
                        <p>â€¢ <strong>é¢‘ç‡ï¼š</strong>é«˜é¢‘ï¼ˆCF_min_timer â‰¥ 800B çº¿è·¯æ—¶é—´ï¼‰</p>
                        <p>â€¢ <strong>å†…å®¹ï¼š</strong>ä¸¤ä¸ª R_VC_CF[x] è®¡æ•°å™¨å€¼</p>
                        <p>â€¢ <strong>ç‰¹æ€§ï¼š</strong>å¯æŠ¢å æ­£åœ¨ä¼ è¾“çš„æ•°æ®åŒ…ï¼ˆ256B ä¹‹åï¼‰</p>
                        <p>â€¢ <strong>å¸¦å®½ï¼š</strong>é€šå¸¸ < 0.5% é“¾è·¯å¸¦å®½</p>
                    </div>
                </div>
                <div class="module-box">
                    <div class="module-header">CC_Update â€” ä¿¡ç”¨æ¶ˆè€—åŒæ­¥æ¶ˆæ¯</div>
                    <div class="module-ref">Sender â†’ Receiver | Packet æ ¼å¼ | 64 Bytes</div>
                    <div class="module-detail">
                        <p>â€¢ <strong>æ–¹å‘ï¼š</strong>å‘é€æ–¹ â†’ æ¥æ”¶æ–¹</p>
                        <p>â€¢ <strong>æ ¼å¼ï¼š</strong>æ ‡å‡† Ethernet Packetï¼Œ64 å­—èŠ‚ (EtherType: 0x8808)</p>
                        <p>â€¢ <strong>é¢‘ç‡ï¼š</strong>ä½é¢‘ (< 0.01% å¸¦å®½)</p>
                        <p>â€¢ <strong>å†…å®¹ï¼š</strong>æœ€å¤š 16 ä¸ª S_VC_CC[x] è®¡æ•°å™¨å€¼</p>
                        <p>â€¢ <strong>ç›®çš„ï¼š</strong>æ¢å¤å›  CRC é”™è¯¯æˆ– FEC é”™è¯¯å¯¼è‡´çš„ä¿¡ç”¨æ³„æ¼</p>
                        <p>â€¢ <strong>ä¿åºï¼š</strong>å¿…é¡»ä¸æ•°æ®åŒ…ä¿æŒç›¸å¯¹é¡ºåº</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ”§ CBFC åˆå§‹åŒ–æµç¨‹ï¼ˆLLDP åå•†ï¼‰</h2>
            <div style="font-family:var(--font-mono); font-size:0.85em; line-height:2; padding:var(--spacing-md); background:rgba(0,0,0,0.2); border-radius:var(--border-radius-sm);">
                <p style="color:var(--accent-cyan)">â‘  Receiver â†’ LLDP TLV: R_VC_WANT[x]=1, R_TotalCredits, R_CellSize, R_PktOvhd</p>
                <p style="color:var(--accent-blue)">â‘¡ Sender è¯»å– Remote DB â†’ é…ç½® VC[x] â†’ è®¾ç½® CreditSize, CreditLimit</p>
                <p style="color:var(--accent-cyan)">â‘¢ Sender â†’ LLDP TLV: S_VC_RTS[x]=1, S_CreditSize, S_PktOvhd</p>
                <p style="color:var(--accent-blue)">â‘£ Receiver è¯»å– Remote DB â†’ é…ç½®æ¥æ”¶å‚æ•°</p>
                <p style="color:var(--accent-green)">â‘¤ Receiver â†’ LLDP TLV: R_VC_RTR[x]=1</p>
                <p style="color:var(--accent-green)">â‘¥ Sender çœ‹åˆ° R_VC_RTR[x]=1 â†’ <strong>å¼€å§‹å‘é€æ•°æ®ï¼</strong></p>
            </div>
            <div class="info-box" style="margin-top:var(--spacing-md)">
                <strong>ä¸‰æ¡æ‰‹è¿‡ç¨‹ï¼š</strong>WANT â†’ RTS â†’ RTRï¼Œç¡®ä¿åŒæ–¹å‚æ•°å®Œå…¨åå•†ä¸€è‡´åæ‰å¼€å§‹ä¼ è¾“ã€‚
                é…ç½®å‚æ•°åŒ…æ‹¬ CreditSizeï¼ˆ32~2048Bï¼‰ã€NumVCsï¼ˆ2~32ï¼‰ã€TotalCreditsï¼ˆæœ€å¤§ 2Â¹â¹-1ï¼‰ç­‰ã€‚
            </div>
        </div>
    </div>

    <!-- ========================== TAB 5: åº”ç”¨åœºæ™¯ ========================== -->
    <div class="tab-content" id="tab-scenarios">
        <div class="section-card">
            <h2>ğŸŒ åº”ç”¨åœºæ™¯åˆ†æ</h2>

            <div class="scenario-grid">
                <div class="scenario-card">
                    <div class="scenario-icon">ğŸ§ </div>
                    <div class="scenario-title">AI/HPC é›†ç¾¤ â€” æ— æŸç½‘ç»œ</div>
                    <div class="scenario-desc">
                        å¤§è§„æ¨¡ AI è®­ç»ƒå’Œ HPC è®¡ç®—éœ€è¦æä½çš„ä¸¢åŒ…ç‡ã€‚CBFC é€šè¿‡ä¿¡ç”¨æœºåˆ¶åœ¨é“¾è·¯å±‚å®ç°é€è·³æ— æŸä¼ è¾“ï¼Œ
                        é…åˆ UE Transport å±‚çš„ç«¯åˆ°ç«¯å¯é ä¼ è¾“ï¼ˆSES/PDSï¼‰ï¼Œæ„å»ºå…¨æ ˆæ— æŸç½‘ç»œã€‚
                        æ¯ä¸ª VC çš„ç‹¬ç«‹ä¿¡ç”¨æ§åˆ¶é¿å…äº†å¤´éƒ¨é˜»å¡é—®é¢˜ã€‚
                    </div>
                    <div class="scenario-tags">
                        <span class="feature-tag tag-cbfc">CBFC æ¨è</span>
                        <span class="feature-tag tag-cbfc">Lossless Fabric</span>
                    </div>
                </div>

                <div class="scenario-card">
                    <div class="scenario-icon">ğŸ”€</div>
                    <div class="scenario-title">å¤šç§Ÿæˆ·äº¤æ¢ç½‘ç»œ â€” æ··åˆæµæ§</div>
                    <div class="scenario-desc">
                        åœ¨å¤šç§Ÿæˆ·æ•°æ®ä¸­å¿ƒï¼Œä¸åŒç§Ÿæˆ·å¯èƒ½éœ€è¦ä¸åŒçš„ QoS ä¿è¯ã€‚CBFC çš„ 32 ä¸ª VC å¯ä»¥ä¸ºä¸åŒç§Ÿæˆ·æˆ–æµé‡ç±»å‹
                        åˆ†é…ç‹¬ç«‹çš„ä¿¡ç”¨ç©ºé—´ï¼Œä½ååé‡ç”¨æˆ·åˆ†é…å°‘é‡ä¿¡ç”¨å³å¯ã€‚PFC å¯åŒæ—¶ç®¡ç†å…¶ä»–èµ„æºã€‚
                    </div>
                    <div class="scenario-tags">
                        <span class="feature-tag tag-cbfc">CBFC</span>
                        <span class="feature-tag tag-bfc">PFC</span>
                        <span class="feature-tag tag-both">å¯å…±å­˜</span>
                    </div>
                </div>

                <div class="scenario-card">
                    <div class="scenario-icon">ğŸï¸</div>
                    <div class="scenario-title">800GE è¶…é«˜é€Ÿé“¾è·¯</div>
                    <div class="scenario-desc">
                        åœ¨ 800 Gb/s ä»¥å¤ªç½‘é“¾è·¯ä¸Šï¼ŒPFC å¯¹çº¿ç¼†å»¶è¿Ÿæå…¶æ•æ„Ÿã€‚ä»¥ 500m é“œç¼†ä¸ºä¾‹ï¼ŒRTT â‰ˆ 5Âµsï¼Œ
                        åœ¨æ­¤æœŸé—´å¯ä¼ è¾“çº¦ 7.8k ä¸ª 64B ä¿¡ç”¨çš„æ•°æ®ã€‚CBFC çš„ä¿¡ç”¨é¢„æˆæƒæœºåˆ¶é¿å…äº†è¿™ç§æ—¶åºé£é™©ï¼Œ
                        å³ä½¿å»¶è¿Ÿä¼°ç®—é”™è¯¯ä¹Ÿåªæ˜¯é™ä½åˆ©ç”¨ç‡è€Œéä¸¢åŒ…ã€‚
                    </div>
                    <div class="scenario-tags">
                        <span class="feature-tag tag-cbfc">CBFC ä¼˜åŠ¿æ˜æ˜¾</span>
                    </div>
                </div>

                <div class="scenario-card">
                    <div class="scenario-icon">ğŸ“¡</div>
                    <div class="scenario-title">é•¿è·ç¦»é“¾è·¯ (> 100m)</div>
                    <div class="scenario-desc">
                        CBFC ä¸æ•æ„Ÿäºçº¿ç¼†é•¿åº¦ã€‚åœ¨é•¿è·ç¦»é“¾è·¯ä¸­ï¼ŒPFC éœ€è¦æ›´å¤§çš„çªå‘å¸æ”¶ç¼“å†²æ¥åº”å¯¹ä¿¡å·å¾€è¿”å»¶è¿Ÿï¼Œ
                        è€Œ CBFC è‡ªç„¶é€‚åº”ï¼Œå› ä¸ºå‘é€æ–¹å§‹ç»ˆçŸ¥é“æ¥æ”¶æ–¹çš„å¯ç”¨ç©ºé—´ã€‚
                        éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ›´é•¿çš„é“¾è·¯éœ€è¦æ›´å¤šä¿¡ç”¨æ¥ä¿æŒé“¾è·¯åˆ©ç”¨ç‡ã€‚
                    </div>
                    <div class="scenario-tags">
                        <span class="feature-tag tag-cbfc">CBFC æ¨è</span>
                    </div>
                </div>

                <div class="scenario-card">
                    <div class="scenario-icon">âš¡</div>
                    <div class="scenario-title">æœ€ä½³åŠªåŠ›ï¼ˆBest-Effortï¼‰ç½‘ç»œ</div>
                    <div class="scenario-desc">
                        åœ¨ best-effort ç½‘ç»œä¸­ï¼ŒUET å±‚é€šè¿‡ç«¯åˆ°ç«¯é‡ä¼ å’Œæ‹¥å¡æ§åˆ¶ä¿è¯å¯é ä¼ è¾“ã€‚æ­¤æ—¶ CBFC å’Œ PFC
                        å‡<strong>ä¸å»ºè®®</strong>åœ¨ switch-to-switch é“¾è·¯ä¸Šå¯ç”¨ï¼Œå› ä¸ºä¼šè¿åæ‹¥å¡æ§åˆ¶ç®—æ³•çš„å»¶è¿Ÿå‡è®¾ã€‚
                        ç«¯åˆ°ç«¯ UET-CC æ˜¯æ­£ç¡®çš„æ‹¥å¡ç®¡ç†æ–¹å¼ã€‚
                    </div>
                    <div class="scenario-tags">
                        <span class="feature-tag tag-both">å‡ä¸æ¨è</span>
                    </div>
                </div>

                <div class="scenario-card">
                    <div class="scenario-icon">ğŸ”„</div>
                    <div class="scenario-title">è‡ªé€‚åº”è·¯ç”±ä¸è´Ÿè½½å‡è¡¡</div>
                    <div class="scenario-desc">
                        CBFC çš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼šå‘é€æ–¹çŸ¥é“æ¯ä¸ª VC çš„ä¿¡ç”¨ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯åšå‡ºæ›´æ™ºèƒ½çš„è°ƒåº¦å†³ç­–ï¼Œ
                        åŒ…æ‹¬è‡ªé€‚åº”è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€‚PFC åªèƒ½å‘Šè¯‰å‘é€æ–¹"åœ"æˆ–"èµ°"ï¼Œæ— æ³•æä¾›è¿™ç§ç»†ç²’åº¦ä¿¡æ¯ã€‚
                    </div>
                    <div class="scenario-tags">
                        <span class="feature-tag tag-cbfc">CBFC ç‹¬æœ‰</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ“‹ åœºæ™¯é€‰æ‹©å†³ç­–æ ‘</h2>
            <div style="font-family:var(--font-mono); font-size:0.88em; line-height:2.2; padding:var(--spacing-lg); background:rgba(0,0,0,0.2); border-radius:var(--border-radius-sm);">
                <p>éœ€è¦ <strong>é€è·³æ— æŸ</strong> ä¼ è¾“ï¼Ÿ</p>
                <p style="padding-left:2em;">â”œâ”€ æ˜¯ â†’ éœ€è¦ <strong>ç²¾ç»† VC æ§åˆ¶</strong>ï¼ˆ> 8 ä¸ªä¼˜å…ˆçº§ï¼‰ï¼Ÿ</p>
                <p style="padding-left:4em;">â”‚   â”œâ”€ æ˜¯ â†’ <span class="feature-tag tag-cbfc">ä½¿ç”¨ CBFC</span>ï¼ˆæœ€å¤š 32 VCsï¼‰</p>
                <p style="padding-left:4em;">â”‚   â””â”€ å¦ â†’ å¯¹ <strong>çº¿ç¼†å»¶è¿Ÿæ•æ„Ÿ</strong>ï¼Ÿ</p>
                <p style="padding-left:6em;">â”‚       â”œâ”€ æ˜¯ â†’ <span class="feature-tag tag-cbfc">ä½¿ç”¨ CBFC</span></p>
                <p style="padding-left:6em;">â”‚       â””â”€ å¦ â†’ éœ€è¦ <strong>æœ€ç®€å®ç°</strong>ï¼Ÿ</p>
                <p style="padding-left:8em;">â”‚           â”œâ”€ æ˜¯ â†’ <span class="feature-tag tag-bfc">ä½¿ç”¨ PFC</span></p>
                <p style="padding-left:8em;">â”‚           â””â”€ å¦ â†’ <span class="feature-tag tag-both">CBFC + PFC å…±å­˜</span></p>
                <p style="padding-left:2em;">â””â”€ å¦ â†’ <strong>Best-Effort</strong> ç½‘ç»œ</p>
                <p style="padding-left:4em;">    â””â”€ ä½¿ç”¨ç«¯åˆ°ç«¯ UET-CC æ‹¥å¡æ§åˆ¶ <span style="color:var(--accent-green)">(æ¨è)</span></p>
            </div>
        </div>
    </div>

    <!-- ========================== TAB 6: æŠ€æœ¯ç»†èŠ‚ ========================== -->
    <div class="tab-content" id="tab-detail">
        <div class="section-card">
            <h2>ğŸ”¬ CBFC å¾ªç¯è®¡æ•°å™¨æœºåˆ¶</h2>
            <p style="color:var(--text-secondary);">
                CBFC ä½¿ç”¨å¾ªç¯ï¼ˆwrap-aroundï¼‰è®¡æ•°å™¨æ¥è·Ÿè¸ªä¿¡ç”¨ï¼Œç¡®ä¿åœ¨ä¸¢åŒ…æˆ–æ¶ˆæ¯ä¸¢å¤±æ—¶çš„å¼¹æ€§æ¢å¤ã€‚
            </p>
            <div class="compare-grid" style="margin-top:var(--spacing-lg);">
                <div class="module-box">
                    <div class="module-header">CC è®¡æ•°å™¨ (Credit Consumed)</div>
                    <div class="module-detail">
                        <p>â€¢ <strong>å®½åº¦ï¼š</strong>20 bits (æ”¯æŒ 2Â¹â¹ credits)</p>
                        <p>â€¢ <strong>Sender ä¾§ï¼š</strong>æ¯å‘é€ä¸€ä¸ªåŒ…ï¼ŒCC += è¯¥åŒ…æ‰€éœ€ä¿¡ç”¨æ•°</p>
                        <p>â€¢ <strong>Receiver ä¾§ï¼š</strong>æ¯æ¥æ”¶ä¸€ä¸ªåŒ…ï¼ŒCC += è¯¥åŒ…æ‰€éœ€ä¿¡ç”¨æ•°</p>
                        <p>â€¢ <strong>åŒæ­¥ï¼š</strong>Sender é€šè¿‡ CC_Update åŒ…å‘é€ S_VC_CC[x]</p>
                        <p>â€¢ <strong>æ¯”è¾ƒï¼š</strong>Receiver å¯¹æ¯” S_VC_CC[x] ä¸ R_VC_CC[x]</p>
                        <p>â€¢ <strong>ä¿¡ç”¨æ¢å¤ï¼š</strong>å¦‚æœ S_CC < R_CCï¼Œè¯´æ˜æœ‰åŒ…ä¸¢å¤±ï¼ŒReceiver è°ƒæ•´è®¡æ•°</p>
                    </div>
                </div>
                <div class="module-box">
                    <div class="module-header">CF è®¡æ•°å™¨ (Credit Freed)</div>
                    <div class="module-detail">
                        <p>â€¢ <strong>å®½åº¦ï¼š</strong>15 bits (æ”¯æŒ 16k in-flight credits)</p>
                        <p>â€¢ <strong>Receiver ä¾§ï¼š</strong>æ¯é‡Šæ”¾ç¼“å†²åŒºç©ºé—´ï¼ŒCF += é‡Šæ”¾çš„ä¿¡ç”¨æ•°</p>
                        <p>â€¢ <strong>Sender ä¾§ï¼š</strong>æ¥æ”¶ CF_Update åæ›´æ–° S_CF</p>
                        <p>â€¢ <strong>å¯ç”¨ä¿¡ç”¨è®¡ç®—ï¼š</strong></p>
                        <p>  <code>Available = CreditLimit - (S_CC - S_CF)</code></p>
                        <p>â€¢ <strong>Port çº§é™åˆ¶ï¼š</strong></p>
                        <p>  <code>S_P_CU = Î£(S_VC_CC[i] - S_VC_CF[i]) â‰¤ S_P_CL</code></p>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <strong>å¼¹æ€§è®¾è®¡ï¼š</strong>ç”±äºè®¡æ•°å™¨å§‹ç»ˆé€’å¢ä¸”å‘¨æœŸæ€§åŒæ­¥ï¼Œå³ä½¿ CF_Update æ¶ˆæ¯ä¸¢å¤±ï¼Œä¸‹ä¸€æ¬¡åŒæ­¥ä¹Ÿèƒ½è‡ªåŠ¨æ¢å¤æ­£ç¡®çš„ä¿¡ç”¨çŠ¶æ€ã€‚
                è¿™æ¯” PFC çš„ XOFF/XON æœºåˆ¶æ›´ä¸ºå¥å£® â€” PFC å¸§ä¸¢å¤±å¯èƒ½å¯¼è‡´æ­»é”æˆ–ç¼“å†²æº¢å‡ºã€‚
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ“¦ ä¿¡ç”¨è®¡ç®—å…¬å¼</h2>
            <div style="background:rgba(0,0,0,0.3); padding:var(--spacing-lg); border-radius:var(--border-radius-sm); font-family:var(--font-mono); font-size:0.9em; line-height:2.2;">
                <p style="color:var(--accent-cyan)">// æ¯åŒ…æ‰€éœ€ä¿¡ç”¨æ•°è®¡ç®—</p>
                <p>CreditsPerPacket = âŒˆ(PktOvhd + FrameSize) / CreditSizeâŒ‰</p>
                <p></p>
                <p style="color:var(--accent-cyan)">// å‘é€æ–¹å¯ç”¨ä¿¡ç”¨</p>
                <p>VC_Available[x] = VC_CreditLimit[x] - (S_VC_CC[x] - S_VC_CF[x])</p>
                <p></p>
                <p style="color:var(--accent-cyan)">// å‘é€æ¡ä»¶ (Port çº§ + VC çº§)</p>
                <p>CanSend = (VC_Available[x] â‰¥ CreditsPerPacket) AND (S_P_CU + CreditsPerPacket â‰¤ S_P_CL)</p>
                <p></p>
                <p style="color:var(--accent-cyan)">// å¾ªç¯è®¡æ•°å™¨æ¯”è¾ƒ (10-bit example)</p>
                <p>C_new = (C_old + N) mod 2Â¹â°</p>
                <p>A > B  iff  0 < (A - B) mod 2Â¹â° < 2â¹</p>
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ”— CBFC ä¸ LLR äº¤äº’è§„åˆ™</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>è§„åˆ™</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>LLR Replay æœŸé—´ä¸æ›´æ–° S_VC_CC å’Œ S_P_CU</td>
                            <td>é‡ä¼ åŒ…å·²åœ¨é¦–æ¬¡ä¼ è¾“æ—¶è®¡æ•°</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>LLR Discard æœŸé—´ä¸æ›´æ–° R_VC_CCï¼ˆLLR-eligible åŒ…ï¼‰</td>
                            <td>ä¸¢å¼ƒçš„åŒ…å°†åœ¨é‡ä¼ æ—¶è®¡æ•°</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>LLR Discard æœŸé—´ä¸¢å¼ƒæ‰€æœ‰ CC_Update åŒ…</td>
                            <td>é¿å… CC è®¡æ•°å™¨ä¸ä¸€è‡´</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>LLR Discard æœŸé—´ä»å¤„ç† CF_Update CtlOS</td>
                            <td>ä¿æŒä¿¡ç”¨å½’è¿˜æµç¨‹ä¸ä¸­æ–­</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>PFC åŒ…å¿…é¡»æ˜¯ LLR-ineligible</td>
                            <td>PFC ä¸å‚ä¸ LLR é‡ä¼ </td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>å»ºè®® CBFC Lossless åŒ…åŒæ—¶ä¸º LLR-eligible</td>
                            <td>åŒé‡ä¿éšœï¼šé“¾è·¯çº§é‡ä¼  + ä¿¡ç”¨æµæ§</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ“ CtlOS æ’å…¥è§„åˆ™</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>è§„åˆ™</th>
                            <th>è¦æ±‚</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>å¯¹é½</td><td>CtlOS å¿…é¡» 8 å­—èŠ‚å¯¹é½ï¼ŒxMII æ§åˆ¶ç åœ¨ lane 0</td></tr>
                        <tr><td>æŠ¢å é™åˆ¶</td><td>ä¸å¾—åœ¨åŒ…çš„å‰ 256 å­—èŠ‚å†…æŠ¢å </td></tr>
                        <tr><td>æœ€å°é—´è·</td><td>ä¸¤ä¸ª CtlOS ä¹‹é—´è‡³å°‘ 400Bï¼ˆä¿è¯ < 2% å¸¦å®½ï¼‰</td></tr>
                        <tr><td>æ¨èé—´è·</td><td>~1600Bï¼ˆä¿æŒ < 0.5% å¸¦å®½ï¼‰</td></tr>
                        <tr><td>PCS ç¼–ç </td><td>O-code = 0x6ï¼ˆåŒºåˆ«äºåºåˆ—æœ‰åºé›† O-code = 0x0ï¼‰</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div><!-- end container -->

<!-- ====== Footer ====== -->
<div class="page-footer">
    CBFC vs BFC â€” åŸºäº Ultra Ethernet Specification v1.0 Â§5.2 | UE Consortiumâ„¢ 2025
</div>

<!-- ====== Scripts ====== -->
<script src="common.js"></script>
<script>
(function() {
    'use strict';

    // ============================================
    // Tab Initialization
    // ============================================
    CommonTabs.init('#main-tabs');
    CommonNav.init('cbfc_vs_bfc', [
        { id: 'cbfc_vs_bfc', label: 'CBFC vs BFC', file: 'cbfcVSbfc.html' }
    ]);

    // ============================================
    // CBFC Animation State
    // ============================================
    const CBFC_TOTAL_STEPS = 40;
    const CBFC_CREDIT_LIMIT = 16;
    let cbfcState = {
        step: 0,
        sCC: 0, sCF: 0,
        rCC: 0, rCF: 0,
        rxBuffer: [],  // array of VC indices
        bufferCapacity: 16,
        pendingCF: 0,
        pktsInFlight: []
    };

    function cbfcReset() {
        cbfcState = {
            step: 0,
            sCC: 0, sCF: 0,
            rCC: 0, rCF: 0,
            rxBuffer: [],
            bufferCapacity: 16,
            pendingCF: 0,
            pktsInFlight: []
        };
        document.getElementById('cbfc-log').innerHTML = '';
        cbfcUpdateUI();
        clearSVGPackets('cbfc-packets');
        const btn = document.getElementById('cbfc-play-btn');
        btn.textContent = 'â–¶ æ’­æ”¾';
    }

    function cbfcStep() {
        if (cbfcState.step >= CBFC_TOTAL_STEPS) return false;
        cbfcState.step++;
        const s = cbfcState;

        // Drain 1 packet from receiver buffer every 2 steps
        if (s.step % 2 === 0 && s.rxBuffer.length > 0) {
            s.rxBuffer.shift();
            s.rCF++;
            s.pendingCF++;
            cbfcLog('cbfc-msg', `Receiver: é‡Šæ”¾ç¼“å†² â†’ R_CF[0]=${s.rCF}`);
        }

        // Return credits (CF_Update) every 3 steps
        if (s.step % 3 === 0 && s.pendingCF > 0) {
            s.sCF += s.pendingCF;
            cbfcLog('cbfc-msg', `CF_Update (CtlOS 8B): R_VC_CF[0]=${s.rCF} â†’ Sender æ›´æ–° S_CF=${s.sCF}`);
            animateSVGPacket('cbfc-packets', 580, 195, 220, 195, '#ffab40', 'CF');
            s.pendingCF = 0;
        }

        // Send CC_Update every 10 steps
        if (s.step % 10 === 0 && s.step > 0) {
            cbfcLog('data-msg', `CC_Update (64B Pkt): S_VC_CC[0]=${s.sCC} â†’ Receiver æ ¸å¯¹`);
            animateSVGPacket('cbfc-packets', 220, 175, 580, 175, '#4fc3f7', 'CC');
            // Receiver verifies
            if (s.sCC !== s.rCC) {
                const leaked = s.rCC - s.sCC;
                cbfcLog('warn-msg', `âš  æ£€æµ‹åˆ°ä¿¡ç”¨æ³„æ¼: S_CC=${s.sCC} vs R_CC=${s.rCC}, å·®å¼‚=${leaked}`);
                s.rCC = s.sCC;
            }
        }

        // Try to send data packet
        const avail = CBFC_CREDIT_LIMIT - (s.sCC - s.sCF);
        if (avail >= 1 && s.step % 1 === 0) {
            s.sCC++;
            s.rCC++;
            s.rxBuffer.push(0);
            cbfcLog('data-msg', `Sender: å‘é€ PKT â†’ S_CC[0]=${s.sCC}, Available=${CBFC_CREDIT_LIMIT - (s.sCC - s.sCF)}`);
            animateSVGPacket('cbfc-packets', 220, 185, 580, 185, '#64ffda', 'D');
        } else if (avail < 1) {
            cbfcLog('warn-msg', `â¸ Sender: VC[0] ä¿¡ç”¨ä¸è¶³ (avail=${avail})ï¼Œç­‰å¾… CF_Update...`);
        }

        cbfcUpdateUI();
        return s.step < CBFC_TOTAL_STEPS;
    }

    function cbfcUpdateUI() {
        const s = cbfcState;
        const avail = CBFC_CREDIT_LIMIT - (s.sCC - s.sCF);

        document.getElementById('cbfc-s-cc').textContent = s.sCC;
        document.getElementById('cbfc-s-cf').textContent = s.sCF;
        document.getElementById('cbfc-avail').textContent = Math.max(0, avail);
        document.getElementById('cbfc-r-cc').textContent = s.rCC;
        document.getElementById('cbfc-r-cf').textContent = s.rCF;

        // SVG text
        const svgSCC = document.getElementById('cbfc-svg-scc');
        const svgSCF = document.getElementById('cbfc-svg-scf');
        const svgAvail = document.getElementById('cbfc-svg-avail');
        const svgRCC = document.getElementById('cbfc-svg-rcc');
        const svgRCF = document.getElementById('cbfc-svg-rcf');
        if (svgSCC) svgSCC.textContent = s.sCC;
        if (svgSCF) svgSCF.textContent = s.sCF;
        if (svgAvail) svgAvail.textContent = Math.max(0, avail);
        if (svgRCC) svgRCC.textContent = s.rCC;
        if (svgRCF) svgRCF.textContent = s.rCF;

        // Sender queue bar
        const qBar = document.getElementById('cbfc-sender-q');
        if (qBar) {
            const usage = Math.min(100, ((s.sCC - s.sCF) / CBFC_CREDIT_LIMIT) * 140);
            qBar.setAttribute('width', Math.max(0, usage));
        }

        // Receiver buffer visualization
        const bufGroup = document.getElementById('cbfc-rx-buffer');
        if (bufGroup) {
            bufGroup.innerHTML = '';
            for (let i = 0; i < s.bufferCapacity; i++) {
                const x = 610 + i * 9;
                const used = i < s.rxBuffer.length;
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', used ? 182 : 194);
                rect.setAttribute('width', 7);
                rect.setAttribute('height', used ? 18 : 6);
                rect.setAttribute('rx', 1);
                rect.setAttribute('fill', used ? '#64ffda' : 'rgba(100,255,218,0.15)');
                bufGroup.appendChild(rect);
            }
        }

        // Progress
        const pct = (s.step / CBFC_TOTAL_STEPS) * 100;
        document.getElementById('cbfc-progress').style.width = pct + '%';
        document.getElementById('cbfc-step-label').textContent = `Step ${s.step} / ${CBFC_TOTAL_STEPS}`;
    }

    function cbfcLog(cls, msg) {
        const log = document.getElementById('cbfc-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + cls;
        entry.innerHTML = `<span class="log-time">[Step ${cbfcState.step}]</span>${msg}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    const cbfcAnim = new AnimationController({
        stepFn: cbfcStep,
        interval: 800,
        onReset: cbfcReset,
        onComplete() {
            cbfcLog('cbfc-msg', 'âœ… CBFC åŠ¨ç”»å®Œæˆ');
            document.getElementById('cbfc-play-btn').textContent = 'â–¶ æ’­æ”¾';
        }
    });

    // Override toggle for button text
    const origCbfcToggle = cbfcAnim.toggle.bind(cbfcAnim);
    cbfcAnim.toggle = function() {
        origCbfcToggle();
        const btn = document.getElementById('cbfc-play-btn');
        btn.textContent = cbfcAnim.isRunning ? 'â¸ æš‚åœ' : 'â–¶ æ’­æ”¾';
    };
    cbfcAnim.reset = function() {
        cbfcAnim.stop();
        cbfcReset();
    };

    window.cbfcAnim = cbfcAnim;

    // ============================================
    // BFC (PFC) Animation State
    // ============================================
    const BFC_TOTAL_STEPS = 40;
    const BFC_BUF_TOTAL = 16;
    const BFC_XOFF_THRESHOLD = 12;
    let bfcState = {
        step: 0,
        bufUsed: 0,
        senderPaused: false,
        pktsSent: 0,
        pktsDropped: 0,
        pauseTimer: 0
    };

    function bfcReset() {
        bfcState = {
            step: 0,
            bufUsed: 0,
            senderPaused: false,
            pktsSent: 0,
            pktsDropped: 0,
            pauseTimer: 0
        };
        document.getElementById('bfc-log').innerHTML = '';
        bfcUpdateUI();
        clearSVGPackets('bfc-packets');
        document.getElementById('bfc-play-btn').textContent = 'â–¶ æ’­æ”¾';
    }

    function bfcStep() {
        if (bfcState.step >= BFC_TOTAL_STEPS) return false;
        bfcState.step++;
        const s = bfcState;

        // Drain 1 packet every 2 steps
        if (s.step % 2 === 0 && s.bufUsed > 0) {
            s.bufUsed--;
            bfcLog('bfc-msg', `Receiver: å¤„ç† 1 åŒ… â†’ Buffer=${s.bufUsed}/${BFC_BUF_TOTAL}`);
        }

        // Check if we should send XON (buffer below half threshold)
        if (s.senderPaused && s.bufUsed < BFC_XOFF_THRESHOLD / 2) {
            s.senderPaused = false;
            s.pauseTimer = 0;
            bfcLog('bfc-msg', `PFC XON â†’ Sender æ¢å¤å‘é€ (Buffer=${s.bufUsed})`);
            animateSVGPacket('bfc-packets', 580, 195, 220, 195, '#69f0ae', 'XON');
        }

        // Pause timer countdown
        if (s.senderPaused) {
            s.pauseTimer--;
            if (s.pauseTimer <= 0) {
                s.senderPaused = false;
                bfcLog('bfc-msg', `PFC æš‚åœæ—¶é—´åˆ°æœŸ â†’ Sender æ¢å¤`);
            }
        }

        // Sender tries to send (2 packets per step when active)
        if (!s.senderPaused) {
            const sendCount = (s.step > 15 && s.step < 30) ? 3 : 2; // burst
            for (let i = 0; i < sendCount; i++) {
                if (s.bufUsed < BFC_BUF_TOTAL) {
                    s.bufUsed++;
                    s.pktsSent++;
                    animateSVGPacket('bfc-packets', 220, 185, 580, 185, '#ffab40', 'D');
                } else {
                    s.pktsDropped++;
                    bfcLog('warn-msg', `ğŸ’€ ç¼“å†²æº¢å‡ºï¼ä¸¢åŒ… #${s.pktsDropped}ï¼ˆBuffer FULLï¼‰`);
                    animateSVGPacket('bfc-packets', 220, 185, 450, 185, '#ff5252', 'X');
                }
            }
            bfcLog('data-msg', `Sender: å‘é€ ${sendCount} åŒ… â†’ Buffer=${s.bufUsed}/${BFC_BUF_TOTAL}`);
        } else {
            bfcLog('warn-msg', `â¸ Sender: PAUSED (timer=${s.pauseTimer})`);
        }

        // Check XOFF threshold
        if (s.bufUsed >= BFC_XOFF_THRESHOLD && !s.senderPaused) {
            s.senderPaused = true;
            s.pauseTimer = 5;
            bfcLog('bfc-msg', `PFC XOFF â†’ Buffer=${s.bufUsed} â‰¥ Threshold=${BFC_XOFF_THRESHOLD}, æš‚åœ 5 steps`);
            animateSVGPacket('bfc-packets', 580, 215, 220, 215, '#ff5252', 'XOFF');
        }

        bfcUpdateUI();
        return s.step < BFC_TOTAL_STEPS;
    }

    function bfcUpdateUI() {
        const s = bfcState;
        document.getElementById('bfc-buf-used').textContent = s.bufUsed;
        document.getElementById('bfc-pkts-sent').textContent = s.pktsSent;
        document.getElementById('bfc-pkts-drop').textContent = s.pktsDropped;

        const stateEl = document.getElementById('bfc-sender-state');
        const svgState = document.getElementById('bfc-svg-state');
        const svgSent = document.getElementById('bfc-svg-sent');
        const svgDrop = document.getElementById('bfc-svg-drop');
        const svgUsed = document.getElementById('bfc-svg-used');
        const barText = document.getElementById('bfc-sender-bar-text');
        const indicator = document.getElementById('bfc-sender-indicator');

        if (s.senderPaused) {
            stateEl.textContent = 'PAUSED';
            stateEl.style.color = 'var(--accent-red)';
            if (svgState) { svgState.textContent = 'PAUSED'; svgState.setAttribute('fill', '#ff5252'); }
            if (barText) { barText.textContent = 'â¸ PAUSED'; barText.setAttribute('fill', '#ff5252'); }
            if (indicator) indicator.setAttribute('fill', 'rgba(255,82,82,0.2)');
        } else {
            stateEl.textContent = 'SENDING';
            stateEl.style.color = 'var(--accent-green)';
            if (svgState) { svgState.textContent = 'SENDING'; svgState.setAttribute('fill', '#69f0ae'); }
            if (barText) { barText.textContent = 'â— ACTIVE'; barText.setAttribute('fill', '#69f0ae'); }
            if (indicator) indicator.setAttribute('fill', 'rgba(0,0,0,0.3)');
        }

        if (svgSent) svgSent.textContent = s.pktsSent;
        if (svgDrop) svgDrop.textContent = s.pktsDropped;
        if (svgUsed) svgUsed.textContent = s.bufUsed;

        // Buffer bar
        const bufBar = document.getElementById('bfc-rx-buf-bar');
        if (bufBar) {
            const w = (s.bufUsed / BFC_BUF_TOTAL) * 140;
            bufBar.setAttribute('width', w);
            if (s.bufUsed >= BFC_XOFF_THRESHOLD) {
                bufBar.setAttribute('fill', '#ff5252');
            } else if (s.bufUsed >= BFC_XOFF_THRESHOLD * 0.7) {
                bufBar.setAttribute('fill', '#ffab40');
            } else {
                bufBar.setAttribute('fill', '#69f0ae');
            }
        }

        const pct = (s.step / BFC_TOTAL_STEPS) * 100;
        document.getElementById('bfc-progress').style.width = pct + '%';
        document.getElementById('bfc-step-label').textContent = `Step ${s.step} / ${BFC_TOTAL_STEPS}`;
    }

    function bfcLog(cls, msg) {
        const log = document.getElementById('bfc-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + cls;
        entry.innerHTML = `<span class="log-time">[Step ${bfcState.step}]</span>${msg}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    const bfcAnim = new AnimationController({
        stepFn: bfcStep,
        interval: 800,
        onReset: bfcReset,
        onComplete() {
            bfcLog('bfc-msg', `âœ… BFC åŠ¨ç”»å®Œæˆ â€” å…±å‘é€ ${bfcState.pktsSent} åŒ…, ä¸¢å¼ƒ ${bfcState.pktsDropped} åŒ…`);
            document.getElementById('bfc-play-btn').textContent = 'â–¶ æ’­æ”¾';
        }
    });

    const origBfcToggle = bfcAnim.toggle.bind(bfcAnim);
    bfcAnim.toggle = function() {
        origBfcToggle();
        document.getElementById('bfc-play-btn').textContent = bfcAnim.isRunning ? 'â¸ æš‚åœ' : 'â–¶ æ’­æ”¾';
    };
    bfcAnim.reset = function() {
        bfcAnim.stop();
        bfcReset();
    };

    window.bfcAnim = bfcAnim;

    // ============================================
    // SVG Packet Animation Helper
    // ============================================
    function animateSVGPacket(groupId, x1, y1, x2, y2, color, label) {
        const group = document.getElementById(groupId);
        if (!group) return;

        const ns = 'http://www.w3.org/2000/svg';

        // Circle
        const circle = document.createElementNS(ns, 'circle');
        circle.setAttribute('cx', x1);
        circle.setAttribute('cy', y1);
        circle.setAttribute('r', 6);
        circle.setAttribute('fill', color);
        circle.style.filter = `drop-shadow(0 0 4px ${color})`;

        // Label
        const text = document.createElementNS(ns, 'text');
        text.setAttribute('x', x1);
        text.setAttribute('y', y1 - 10);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', color);
        text.setAttribute('font-size', '9');
        text.setAttribute('font-family', 'monospace');
        text.setAttribute('font-weight', '700');
        text.textContent = label;

        group.appendChild(circle);
        group.appendChild(text);

        // Animate
        const duration = 600;
        const start = performance.now();

        function animate(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);

            const cx = x1 + (x2 - x1) * eased;
            const cy = y1 + (y2 - y1) * eased;

            circle.setAttribute('cx', cx);
            circle.setAttribute('cy', cy);
            text.setAttribute('x', cx);
            text.setAttribute('y', cy - 10);

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                // Fade out
                circle.style.transition = 'opacity 0.3s';
                text.style.transition = 'opacity 0.3s';
                circle.style.opacity = '0';
                text.style.opacity = '0';
                setTimeout(() => {
                    if (circle.parentNode) circle.parentNode.removeChild(circle);
                    if (text.parentNode) text.parentNode.removeChild(text);
                }, 300);
            }
        }

        requestAnimationFrame(animate);
    }

    function clearSVGPackets(groupId) {
        const group = document.getElementById(groupId);
        if (group) group.innerHTML = '';
    }

    // ============================================
    // Initialize
    // ============================================
    cbfcUpdateUI();
    bfcUpdateUI();

})();
</script>

</body>
</html>